<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budget Tracker</title>
  <meta name="theme-color" content="#111827">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Budget">
  <link rel="manifest" href="/Day_budget/manifest.json">
  <link rel="apple-touch-icon" href="/Day_budget/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/Day_budget/icons/icon-192x192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #111827; }
    .glass { background: rgba(31, 41, 55, 0.8); backdrop-filter: blur(10px); }
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
    .tab-active { background: #3b82f6; color: white; }
    .progress-bar { transition: width 0.5s ease-in-out; }
  </style>
</head>
<body class="min-h-screen text-gray-100 p-4 md:p-6">
  <div id="app" class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-white mb-2">ğŸ’° Budget Tracker</h1>
      <p class="text-gray-400" id="app-subtitle">Household Budget & Renovation Tracker</p>
      <p class="text-xs text-gray-500 mt-1">Data saves to this device â€¢ Install as app from your browser menu</p>
    </div>

```
<!-- Tabs -->
<div class="flex flex-wrap gap-2 mb-6">
  <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-active px-4 py-2 rounded-lg font-medium transition-all">Dashboard</button>
  <button onclick="showTab('renovation')" id="tab-renovation" class="bg-gray-700 px-4 py-2 rounded-lg font-medium transition-all hover:bg-gray-600">Renovation</button>
  <button onclick="showTab('debts')" id="tab-debts" class="bg-gray-700 px-4 py-2 rounded-lg font-medium transition-all hover:bg-gray-600">Debts</button>
  <button onclick="showTab('expenses')" id="tab-expenses" class="bg-gray-700 px-4 py-2 rounded-lg font-medium transition-all hover:bg-gray-600">Expenses</button>
  <button onclick="showTab('goals')" id="tab-goals" class="bg-gray-700 px-4 py-2 rounded-lg font-medium transition-all hover:bg-gray-600">Goals</button>
  <button onclick="showTab('settings')" id="tab-settings" class="bg-gray-700 px-4 py-2 rounded-lg font-medium transition-all hover:bg-gray-600">âš™ï¸</button>
</div>

<!-- Dashboard Tab -->
<div id="content-dashboard" class="tab-content">
  <!-- Top Stats -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="glass rounded-xl p-4 border border-gray-700">
      <div class="text-gray-400 text-sm mb-1">ğŸ’µ Monthly Income</div>
      <div class="text-2xl font-bold text-green-400" id="stat-income">$0</div>
      <div class="text-xs text-gray-500 mt-1" id="stat-income-breakdown"></div>
    </div>
    <div class="glass rounded-xl p-4 border border-gray-700">
      <div class="text-gray-400 text-sm mb-1">ğŸ“Š Monthly Surplus</div>
      <div class="text-2xl font-bold" id="stat-surplus">$0</div>
    </div>
    <div class="glass rounded-xl p-4 border border-gray-700">
      <div class="text-gray-400 text-sm mb-1">ğŸ’³ Total Debt</div>
      <div class="text-2xl font-bold text-orange-400" id="stat-debt">$0</div>
    </div>
    <div class="glass rounded-xl p-4 border border-gray-700">
      <div class="text-gray-400 text-sm mb-1">ğŸ¦ Emergency Fund</div>
      <div class="text-2xl font-bold text-blue-400" id="stat-emergency">$0</div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="grid md:grid-cols-2 gap-6 mb-6">
    <div class="glass rounded-xl p-5 border border-gray-700">
      <h3 class="text-lg font-semibold mb-4">Monthly Cash Flow</h3>
      <canvas id="cashFlowChart" height="200"></canvas>
    </div>
    <div class="glass rounded-xl p-5 border border-gray-700">
      <h3 class="text-lg font-semibold mb-4">Renovation Progress</h3>
      <canvas id="renovationChart" height="200"></canvas>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="glass rounded-xl p-5 border border-gray-700">
    <h3 class="text-lg font-semibold mb-4">Quick Add Expense</h3>
    <div class="flex flex-wrap gap-3">
      <select id="quick-category" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
        <option value="Kitchen">Kitchen</option>
        <option value="Bathrooms">Bathrooms</option>
        <option value="Flooring">Flooring</option>
        <option value="Windows/Doors">Windows/Doors</option>
        <option value="HVAC">HVAC</option>
        <option value="Electrical">Electrical</option>
        <option value="Plumbing">Plumbing</option>
        <option value="Exterior">Exterior</option>
        <option value="Other">Other</option>
      </select>
      <input type="number" id="quick-amount" placeholder="Amount" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 w-32">
      <input type="text" id="quick-note" placeholder="Note (optional)" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 flex-1 min-w-[150px]">
      <button onclick="addRenovationExpense()" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg font-medium">+ Add</button>
    </div>
  </div>
</div>

<!-- Renovation Tab -->
<div id="content-renovation" class="tab-content hidden">
  <!-- HELOC Status -->
  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <div class="flex justify-between items-start mb-4">
      <h3 class="text-lg font-semibold">ğŸ  HELOC Status</h3>
      <span class="text-xs bg-yellow-600/30 text-yellow-300 px-2 py-1 rounded-full" id="heloc-status-badge">Pursuing</span>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-sm">
      <div class="bg-gray-800/50 rounded-lg p-3">
        <div class="text-gray-500 text-xs">Lender</div>
        <div class="text-gray-200 font-medium" id="heloc-lender-display">RenoFi</div>
      </div>
      <div class="bg-gray-800/50 rounded-lg p-3">
        <div class="text-gray-500 text-xs">Fixed Rate</div>
        <div class="text-gray-200 font-medium" id="heloc-rate-display">7.625%</div>
      </div>
      <div class="bg-gray-800/50 rounded-lg p-3">
        <div class="text-gray-500 text-xs">Draw Period</div>
        <div class="text-gray-200 font-medium" id="heloc-draw-period-display">2 years</div>
      </div>
      <div class="bg-gray-800/50 rounded-lg p-3">
        <div class="text-gray-500 text-xs">Repayment</div>
        <div class="text-gray-200 font-medium" id="heloc-repay-display">20 years</div>
      </div>
    </div>
    <div class="mb-4">
      <div class="flex justify-between text-sm mb-2">
        <span class="text-gray-400">Amount Drawn</span>
        <span id="heloc-drawn-display">$0 / $300,000</span>
      </div>
      <div class="h-4 bg-gray-700 rounded-full overflow-hidden">
        <div id="heloc-progress" class="h-full bg-gradient-to-r from-blue-600 to-blue-400 progress-bar" style="width: 0%"></div>
      </div>
      <div class="flex justify-between text-xs text-gray-500 mt-1">
        <span id="heloc-monthly-payment-display">Est. Monthly Payment: $2,347.13 (at full draw)</span>
        <span id="heloc-interest-display">Current Monthly Interest: $0</span>
      </div>
    </div>
    <div class="flex gap-3">
      <input type="number" id="heloc-draw-amount" placeholder="Draw amount" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 flex-1">
      <button onclick="addHelocDraw()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-medium">Draw Funds</button>
    </div>
  </div>

  <!-- Renovation Budget by Category -->
  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <h3 class="text-lg font-semibold mb-4">ğŸ”¨ Renovation Budget</h3>
    <div class="mb-4">
      <div class="flex justify-between text-sm mb-2">
        <span class="text-gray-400">Total Spent</span>
        <span id="reno-total-display">$0 / $300,000</span>
      </div>
      <div class="h-4 bg-gray-700 rounded-full overflow-hidden">
        <div id="reno-progress" class="h-full bg-gradient-to-r from-green-600 to-emerald-400 progress-bar" style="width: 0%"></div>
      </div>
    </div>
    <div id="category-list" class="space-y-3"></div>
  </div>

  <!-- Recent Expenses -->
  <div class="glass rounded-xl p-5 border border-gray-700">
    <h3 class="text-lg font-semibold mb-4">ğŸ“ Recent Renovation Expenses</h3>
    <div id="expense-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
  </div>
</div>

<!-- Debts Tab -->
<div id="content-debts" class="tab-content hidden">
  <!-- Credit Cards -->
  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">ğŸ’³ Credit Cards</h3>
      <button onclick="showAddDebtModal()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded-lg text-sm">+ Add Card</button>
    </div>
    <div id="credit-card-list" class="space-y-3"></div>
    <div class="mt-4 pt-4 border-t border-gray-700 space-y-2">
      <div class="flex justify-between">
        <span class="text-gray-400">Total Credit Card Debt:</span>
        <span class="text-xl font-bold text-orange-400" id="total-cc-debt">$0</span>
      </div>
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">Combined Monthly Interest:</span>
        <span class="text-red-400 font-medium" id="total-cc-interest">$0</span>
      </div>
      <div class="flex justify-between text-sm">
        <span class="text-gray-500">Combined Minimum Payments:</span>
        <span class="text-gray-300" id="total-cc-minimums">$0</span>
      </div>
    </div>
  </div>

  <!-- Student Loans -->
  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <h3 class="text-lg font-semibold mb-4">ğŸ“ Student Loans</h3>
    <div id="student-loan-list" class="space-y-3"></div>
    <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between">
      <span class="text-gray-400">Total Student Loans:</span>
      <span class="text-xl font-bold text-purple-400" id="total-student-loans">$0</span>
    </div>
  </div>

  <!-- Mortgage -->
  <div class="glass rounded-xl p-5 border border-gray-700">
    <h3 class="text-lg font-semibold mb-4" id="mortgage-title">ğŸ¡ Mortgage</h3>
    <div class="grid grid-cols-3 md:grid-cols-6 gap-4 text-center">
      <div>
        <div class="text-gray-400 text-sm">Monthly Payment</div>
        <div class="text-xl font-bold" id="mortgage-payment">$0</div>
      </div>
      <div>
        <div class="text-gray-400 text-sm">Balance</div>
        <div class="text-xl font-bold" id="mortgage-balance">TBD</div>
      </div>
      <div>
        <div class="text-gray-400 text-sm">Rate</div>
        <div class="text-xl font-bold" id="mortgage-rate">TBD</div>
      </div>
      <div>
        <div class="text-gray-400 text-sm">Principal</div>
        <div class="text-lg font-bold text-green-400" id="mortgage-principal">â€”</div>
      </div>
      <div>
        <div class="text-gray-400 text-sm">Interest</div>
        <div class="text-lg font-bold text-red-400" id="mortgage-interest">â€”</div>
      </div>
      <div>
        <div class="text-gray-400 text-sm">Escrow</div>
        <div class="text-lg font-bold text-blue-400" id="mortgage-escrow">â€”</div>
      </div>
    </div>
    <div class="mt-3 pt-3 border-t border-gray-700 flex flex-wrap gap-4 text-xs text-gray-500">
      <span id="mortgage-due-info"></span>
      <span id="mortgage-autopay-info"></span>
      <span id="mortgage-loan-info"></span>
    </div>
  </div>
</div>

<!-- Expenses Tab -->
<div id="content-expenses" class="tab-content hidden">
  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <h3 class="text-lg font-semibold mb-4">ğŸ“‹ Monthly Fixed Expenses</h3>
    <div id="fixed-expense-list" class="space-y-2"></div>
    <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between">
      <span class="text-gray-400">Total Fixed Expenses:</span>
      <span class="text-xl font-bold" id="total-fixed-expenses">$0</span>
    </div>
  </div>

  <div class="glass rounded-xl p-5 border border-gray-700">
    <h3 class="text-lg font-semibold mb-4">âœï¸ Edit Monthly Expense</h3>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
      <select id="edit-expense-name" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
      </select>
      <input type="number" id="edit-expense-amount" placeholder="New amount" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
      <button onclick="updateExpense()" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg font-medium">Update</button>
    </div>
  </div>
</div>

<!-- Goals Tab -->
<div id="content-goals" class="tab-content hidden">
  <!-- Emergency Fund -->
  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <h3 class="text-lg font-semibold mb-4">ğŸ¦ Emergency Fund Goal</h3>
    <div class="mb-4">
      <div class="flex justify-between text-sm mb-2">
        <span class="text-gray-400">Progress</span>
        <span id="emergency-progress-text">$0 / $25,000</span>
      </div>
      <div class="h-6 bg-gray-700 rounded-full overflow-hidden">
        <div id="emergency-progress" class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 progress-bar" style="width: 0%"></div>
      </div>
      <p class="text-xs text-gray-500 mt-2" id="emergency-eta"></p>
    </div>
    <div class="flex gap-3">
      <input type="number" id="emergency-add" placeholder="Add to fund" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 flex-1">
      <button onclick="addToEmergencyFund()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-medium">+ Add</button>
    </div>
  </div>

  <!-- Debt Payoff Goals -->
  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <h3 class="text-lg font-semibold mb-4">ğŸ¯ Debt Payoff Strategy</h3>
    <div class="space-y-4">
      <div class="bg-gray-750 rounded-lg p-4 border border-gray-600">
        <h4 class="font-medium text-green-400 mb-2">Recommended: Avalanche Method</h4>
        <p class="text-sm text-gray-400">Pay minimums on all debts, then put extra money toward the highest interest rate debt first. This saves the most money on interest.</p>
      </div>
      <div id="debt-priority-list" class="space-y-2"></div>
    </div>
  </div>

  <!-- Goals & Action Plans (set via chatbot) -->
  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">ğŸ“‹ Goals & Action Plans</h3>
      <span class="text-xs text-gray-500">Set goals via the chat assistant</span>
    </div>
    <div id="goals-list" class="space-y-3">
      <p class="text-gray-500 text-sm">No goals set yet. Open the chat and say things like:<br>
      â€¢ "Set a goal to pay off the Sapphire in 12 months"<br>
      â€¢ "I want to save $500/month for emergencies"<br>
      â€¢ "Set a monthly debt payoff goal of $2,000"<br>
      â€¢ "Plan to cut dining out to $200/month"</p>
    </div>
  </div>

  <!-- Chat-Decided Action Items -->
  <div class="glass rounded-xl p-5 border border-gray-700">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">ğŸ’¬ Decisions Log</h3>
      <button onclick="clearDecisions()" class="text-xs text-red-400 hover:text-red-300">Clear All</button>
    </div>
    <p class="text-xs text-gray-500 mb-3">Important decisions and plans from your chat conversations â€” synced to Google Sheets when connected.</p>
    <div id="decisions-log" class="space-y-2">
      <p class="text-gray-500 text-sm">No decisions logged yet. The chat assistant will record key decisions here automatically.</p>
    </div>
  </div>
</div>

<!-- Settings Tab -->
<div id="content-settings" class="tab-content hidden">
  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <h3 class="text-lg font-semibold mb-4">ğŸ’µ Income Settings</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="text-gray-400 text-sm" id="label-p1-income">Person 1 Net Monthly</label>
        <input type="number" id="setting-p1-income" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-1">
      </div>
      <div>
        <label class="text-gray-400 text-sm" id="label-p2-income">Person 2 Net Monthly</label>
        <input type="number" id="setting-p2-income" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-1">
      </div>
      <div>
        <label class="text-gray-400 text-sm">VA Benefits Monthly</label>
        <input type="number" id="setting-va-income" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-1">
      </div>
      <div>
        <label class="text-gray-400 text-sm">Other Monthly Income</label>
        <input type="number" id="setting-other-income" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-1">
      </div>
    </div>
    <button onclick="saveIncomeSettings()" class="mt-4 bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg font-medium">Save Income</button>
  </div>

  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <h3 class="text-lg font-semibold mb-4" id="heloc-settings-title">ğŸ  HELOC Settings</h3>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
      <div>
        <label class="text-gray-400 text-sm">Total Available</label>
        <input type="number" id="setting-heloc-total" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-1">
      </div>
      <div>
        <label class="text-gray-400 text-sm">Fixed Rate (%)</label>
        <input type="number" step="0.001" id="setting-heloc-rate" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-1">
      </div>
      <div>
        <label class="text-gray-400 text-sm">Draw Period (years)</label>
        <input type="number" id="setting-heloc-draw-period" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-1">
      </div>
      <div>
        <label class="text-gray-400 text-sm">Repayment Period (years)</label>
        <input type="number" id="setting-heloc-repay-period" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-1">
      </div>
      <div>
        <label class="text-gray-400 text-sm">Est. Monthly Payment (full draw)</label>
        <input type="number" step="0.01" id="setting-heloc-payment" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-1">
      </div>
    </div>
    <button onclick="saveHelocSettings()" class="mt-4 bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg font-medium">Save HELOC Settings</button>
  </div>

  <div class="glass rounded-xl p-5 border border-gray-700 mb-6">
    <h3 class="text-lg font-semibold mb-4">ğŸ”„ Sync & Share</h3>
    <p class="text-sm text-gray-400 mb-4">Keep both phones in sync via Google Sheets. Changes on either phone will sync to the shared sheet.</p>
    <div class="space-y-3 mb-4">
      <div>
        <label class="text-gray-400 text-sm">Google Sheets Web App URL</label>
        <input type="text" id="setting-sheets-url" placeholder="Paste your Google Apps Script URL here" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mt-1 text-sm">
      </div>
      <div class="flex flex-wrap gap-3">
        <button onclick="syncToSheets()" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg font-medium text-sm">â˜ï¸ Push to Sheets</button>
        <button onclick="syncFromSheets()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-medium text-sm">â¬‡ï¸ Pull from Sheets</button>
        <button onclick="shareViaText()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg font-medium text-sm">ğŸ“± Share via Text</button>
      </div>
    </div>
    <p class="text-xs text-gray-500">Push saves your data to the shared sheet. Pull loads the latest. Share via Text sends a snapshot to your partner.</p>
  </div>

  <div class="glass rounded-xl p-5 border border-gray-700">
    <h3 class="text-lg font-semibold mb-4">ğŸ—‘ï¸ Data Management</h3>
    <div class="flex flex-wrap gap-3">
      <button onclick="exportData()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-medium">ğŸ“¥ Export Data</button>
      <button onclick="document.getElementById('import-file').click()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-lg font-medium">ğŸ“¤ Import Data</button>
      <input type="file" id="import-file" accept=".json" onchange="importData(event)" class="hidden">
      <button onclick="resetData()" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded-lg font-medium">ğŸ—‘ï¸ Reset All Data</button>
    </div>
    <p class="text-xs text-gray-500 mt-3">Export your data to share between devices or create a backup. Import to restore.</p>
  </div>
</div>
```

  </div>

  <!-- Chat Button -->

  <button onclick="toggleChat()" id="chat-toggle" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-500 rounded-full shadow-lg flex items-center justify-center transition-all z-40">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  </button>

  <!-- Chat Panel -->

  <div id="chat-panel" class="fixed bottom-0 right-0 md:bottom-6 md:right-6 w-full md:w-96 h-[70vh] md:h-[500px] glass md:rounded-xl shadow-2xl border border-gray-700 flex-col z-50 hidden">
    <!-- Chat Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-700">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
        </div>
        <div>
          <h3 class="font-semibold text-white">Budget Assistant</h3>
          <p class="text-xs text-gray-400">Ask about your finances</p>
        </div>
      </div>
      <button onclick="toggleChat()" class="text-gray-400 hover:text-white p-1">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

```
<!-- Chat Messages -->
<div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
  <div class="flex gap-3">
    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 bg-blue-600">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
    </div>
    <div class="max-w-[80%] rounded-xl px-4 py-2 bg-gray-700 text-gray-100">
      <p class="text-sm">Hi! I know your finances inside and out â€” income, credit card statements, HELOC terms, everything. Try asking:</p>
      <ul class="text-sm text-gray-300 mt-2 space-y-1">
        <li>â€¢ "Can we afford the HELOC?"</li>
        <li>â€¢ "How much interest are we wasting?"</li>
        <li>â€¢ "What should we focus on?"</li>
        <li>â€¢ "Tell me about the Sapphire card"</li>
        <li>â€¢ "How are we doing?"</li>
      </ul>
    </div>
  </div>
</div>

<!-- Chat Input -->
<div class="p-4 border-t border-gray-700">
  <!-- Upload status banner -->
  <div id="upload-status" class="hidden mb-2 px-3 py-2 rounded-lg text-sm bg-blue-900/50 border border-blue-700 text-blue-200">
    <span id="upload-status-text">Processing...</span>
  </div>
  <div class="flex gap-2">
    <button onclick="document.getElementById('chat-file-upload').click()" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg transition-colors flex-shrink-0" title="Upload document (PDF, image, CSV, text)">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
    </button>
    <input type="file" id="chat-file-upload" accept=".pdf,.csv,.txt,.json,.png,.jpg,.jpeg,.xlsx,.xls,.doc,.docx" onchange="handleChatFileUpload(event)" class="hidden" multiple>
    <input type="text" id="chat-input" onkeypress="handleChatKeypress(event)" placeholder="Ask about your budget or upload a doc..." class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500">
    <button onclick="sendChatMessage()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg transition-colors flex-shrink-0">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </button>
  </div>
  <p class="text-xs text-gray-600 mt-1">ğŸ“ Upload statements, bills, pay stubs â€” I'll extract the data into your budget</p>
</div>
```

  </div>

  <!-- Add Debt Modal -->

  <div id="add-debt-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="glass rounded-xl p-6 border border-gray-700 w-full max-w-md mx-4">
      <h3 class="text-lg font-semibold mb-4">Add Credit Card</h3>
      <div class="space-y-3">
        <input type="text" id="new-card-name" placeholder="Card name (e.g., Chase Sapphire)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
        <input type="number" id="new-card-balance" placeholder="Current balance" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
        <input type="number" step="0.01" id="new-card-apr" placeholder="APR %" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
        <input type="number" id="new-card-minimum" placeholder="Minimum payment" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
        <input type="number" id="new-card-limit" placeholder="Credit limit (optional)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
        <input type="text" id="new-card-duedate" placeholder="Due date (e.g., 02/28) (optional)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
      </div>
      <div class="flex gap-3 mt-4">
        <button onclick="hideAddDebtModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg font-medium">Cancel</button>
        <button onclick="addCreditCard()" class="flex-1 bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg font-medium">Add Card</button>
      </div>
    </div>
  </div>

  <script>
    // ===== DATA STRUCTURE =====
    const defaultData = {
      profile: {
        person1Name: '',
        person2Name: '',
        person1Employer: '',
        person2Employer: '',
        location: '',
        helocDesc: '',
        mortgageLender: '',
        appUrl: ''
      },
      income: {
        person1: 0,
        person2: 0,
        other1: 0,
        other2: 0
      },
      incomeLabels: {
        person1: 'Person 1',
        person2: 'Person 2',
        other1: 'Benefits',
        other2: 'Other'
      },
      heloc: {
        total: 0,
        drawn: 0,
        rate: 0,
        drawPeriodYears: 10,
        repaymentYears: 20,
        monthlyPayment: 0,
        lender: '',
        type: '',
        status: 'Not Started'
      },
      renovation: {
        budget: 0,
        categories: {
          'Kitchen': { budget: 0, spent: 0 },
          'Bathrooms': { budget: 0, spent: 0 },
          'Flooring': { budget: 0, spent: 0 },
          'Windows/Doors': { budget: 0, spent: 0 },
          'HVAC': { budget: 0, spent: 0 },
          'Electrical': { budget: 0, spent: 0 },
          'Plumbing': { budget: 0, spent: 0 },
          'Exterior': { budget: 0, spent: 0 },
          'Other': { budget: 0, spent: 0 }
        },
        expenses: []
      },
      creditCards: [],
      studentLoans: [],
      mortgage: {
        payment: 0,
        balance: 0,
        rate: 0
      },
      expenses: {},
      emergencyFund: {
        current: 0,
        target: 0
      },
      goals: [],
      chatLog: [],
      documents: [],
      setupComplete: false,
      lastUpdated: new Date().toISOString()
    };

    // Load or initialize data
    let data = JSON.parse(JSON.stringify(defaultData));
    let dataLoaded = false;

    // Persistent storage helper
    const STORAGE_KEY = 'dayFamilyBudget';

    // ===== HTML SANITIZER =====
    function sanitize(str) {
      if (typeof str !== 'string') return str;
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ===== PROFILE HELPERS =====
    function p1() { return data.profile?.person1Name || 'Person 1'; }
    function p2() { return data.profile?.person2Name || 'Person 2'; }
    function p1Emp() { return data.profile?.person1Employer ? ` (${data.profile.person1Employer})` : ''; }
    function p2Emp() { return data.profile?.person2Employer ? ` (${data.profile.person2Employer})` : ''; }
    function helocLabel() { return data.heloc?.lender || 'HELOC'; }
    function mortLabel() { return data.profile?.mortgageLender || 'Mortgage'; }
    function subtitle() {
      const parts = [];
      if (data.profile?.person1Name && data.profile?.person2Name) parts.push(`${data.profile.person1Name} & ${data.profile.person2Name}`);
      if (data.profile?.location) parts.push(data.profile.location);
      if (data.heloc?.total > 0) parts.push(`${formatCurrency(data.heloc.total)} ${data.heloc.lender || 'HELOC'} Renovation`);
      return parts.length > 0 ? parts.join(' â€¢ ') : 'Household Budget & Renovation Tracker';
    }

    // ===== BACKWARD COMPATIBILITY MIGRATION =====
    function migrateData(d) {
      // Migrate old 'craig/judith' income keys to generic person1/person2
      if (!d.profile) d.profile = JSON.parse(JSON.stringify(defaultData.profile));
      if (!d.incomeLabels) d.incomeLabels = JSON.parse(JSON.stringify(defaultData.incomeLabels));
      if (!d.documents) d.documents = [];
      if (!d.goals) d.goals = [];
      if (!d.chatLog) d.chatLog = [];
      
      if (d.income && d.income.craig !== undefined) {
        // Old format â€” migrate
        d.income.person1 = d.income.craig || 0;
        d.income.person2 = d.income.judith || 0;
        d.income.other1 = d.income.va || 0;
        d.income.other2 = d.income.other || 0;
        delete d.income.craig;
        delete d.income.judith;
        delete d.income.va;
        delete d.income.other;
      }
      
      if (d.setupComplete === undefined) d.setupComplete = true; // existing users already have data
      return d;
    }

    async function loadData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          data = migrateData(JSON.parse(saved));
        }
      } catch (e) {
        console.log('No saved data found, using defaults');
      }
      
      // Always ensure baseline data is present â€” merge, don't overwrite
      ensureBaselineData();
      saveData();
      dataLoaded = true;
      updateAll();
    }

    // Ensures all baseline data exists. User modifications are preserved.
    // New data from uploads/chatbot layers on top.
    function ensureBaselineData() {
      const baseline = getBaselineData();
      
      // Profile â€” fill in if empty
      if (!data.profile || !data.profile.person1Name) {
        data.profile = baseline.profile;
      }
      
      // Income â€” fill if zeros/empty
      if (!data.income || (data.income.person1 === 0 && data.income.person2 === 0)) {
        data.income = baseline.income;
      }
      if (!data.incomeLabels || !data.incomeLabels.person1 || data.incomeLabels.person1 === 'Person 1') {
        data.incomeLabels = baseline.incomeLabels;
      }
      
      // HELOC â€” fill if not configured
      if (!data.heloc || data.heloc.total === 0) {
        data.heloc = baseline.heloc;
      }
      
      // Renovation â€” fill if budget is 0
      if (!data.renovation || data.renovation.budget === 0) {
        data.renovation = baseline.renovation;
      }
      
      // Credit cards â€” fill if empty array
      if (!data.creditCards || data.creditCards.length === 0) {
        data.creditCards = baseline.creditCards;
      }
      
      // Student loans â€” fill if empty
      if (!data.studentLoans || data.studentLoans.length === 0) {
        data.studentLoans = baseline.studentLoans;
      }
      
      // Mortgage â€” fill if payment is 0
      if (!data.mortgage || data.mortgage.payment === 0) {
        data.mortgage = baseline.mortgage;
      }
      
      // Expenses â€” fill if empty object
      if (!data.expenses || Object.keys(data.expenses).length === 0) {
        data.expenses = baseline.expenses;
      }
      
      // Emergency fund â€” fill if target is 0
      if (!data.emergencyFund || data.emergencyFund.target === 0) {
        data.emergencyFund = baseline.emergencyFund;
      }
      
      // Documents â€” always merge (add missing ones, keep existing)
      if (!data.documents) data.documents = [];
      baseline.documents.forEach(bdoc => {
        if (!data.documents.find(d => d.name === bdoc.name)) {
          data.documents.push(bdoc);
        }
      });
      
      // Ensure arrays exist
      if (!data.goals) data.goals = [];
      if (!data.chatLog) data.chatLog = [];
      
      data.setupComplete = true;
    }

    async function saveData() {
      data.lastUpdated = new Date().toISOString();
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('Failed to save data:', e);
      }
    }

    // ===== BASELINE DATA =====
    // All contextual data from uploaded statements and conversation history.
    // ensureBaselineData() merges this into localStorage on every load.
    // User modifications and new uploads are always preserved on top.
    function getBaselineData() {
      return {
      // Profile
      profile: {
        person1Name: 'Craig',
        person2Name: 'Judith',
        person1Employer: 'Comcast',
        person2Employer: 'Signature Science',
        location: 'Cherry Hill, NJ',
        mortgageLender: 'Freedom Mortgage',
        appUrl: 'https://caday89-boop.github.io/Day_budget/',
        helocDesc: '$300k RenoFi HELOC Renovation'
      },

      // Income
      income: {
        person1: 8757,
        person2: 5629,
        other1: 1663,
        other2: 0
      },
      incomeLabels: {
        person1: 'Craig',
        person2: 'Judith',
        other1: 'VA Benefits',
        other2: 'Other'
      },

      // HELOC
      heloc: {
        total: 300000,
        drawn: 0,
        rate: 7.625,
        drawPeriodYears: 2,
        repaymentYears: 20,
        monthlyPayment: 2347.13,
        lender: 'RenoFi Fixed Rate HELOC',
        type: 'Fixed Rate',
        status: 'Pursuing'
      },

      // Renovation budget
      renovation: {
        budget: 300000,
        categories: {
          'Kitchen': { budget: 80000, spent: 0 },
          'Bathrooms': { budget: 45000, spent: 0 },
          'Flooring': { budget: 35000, spent: 0 },
          'Windows/Doors': { budget: 25000, spent: 0 },
          'HVAC': { budget: 20000, spent: 0 },
          'Electrical': { budget: 15000, spent: 0 },
          'Plumbing': { budget: 15000, spent: 0 },
          'Exterior': { budget: 30000, spent: 0 },
          'Other': { budget: 35000, spent: 0 }
        },
        expenses: []
      },

      // Credit cards (from Chase statements uploaded 02/2026)
      creditCards: [
        {
          name: 'Chase Sapphire Reserve',
          balance: 29473.80,
          apr: 24.99,
          minimum: 1941.68,
          limit: 29400,
          dueDate: '02/28',
          lastInterest: 525.84,
          lastStmtDate: '02/03/26',
          autopay: true,
          rewards: '39,332 Ultimate Rewards pts'
        },
        {
          name: 'Chase Amazon Prime Visa',
          balance: 9475.36,
          apr: 22.74,
          minimum: 265.00,
          limit: 19900,
          dueDate: '02/20',
          lastInterest: 170.85,
          lastStmtDate: '01/23/26',
          autopay: false,
          rewards: '3,462 pts ($34.62)'
        }
      ],

      // Student loans
      studentLoans: [
        { name: 'Federal Loan 1', balance: 0, rate: 0, payment: 561.49 },
        { name: 'Federal Loan 2', balance: 0, rate: 0, payment: 153.23 }
      ],

      // Mortgage (Freedom Mortgage statement 02/02/26)
      mortgage: {
        payment: 2532.22,
        balance: 309693.86,
        rate: 1.75,
        loanNumber: '0146338439',
        escrowBalance: 3286.97,
        principalPaid: 824.97,
        interestPaid: 451.64,
        escrowPaid: 1255.61,
        nextDueDate: '03/01/26',
        lateFee: 101.28,
        lateFeeDate: '03/16/26',
        autopay: true,
        ytdPrincipal: 1646.34,
        ytdInterest: 906.88,
        ytdEscrow: 2511.22,
        ytdTotal: 5064.44,
        lastStmtDate: '02/02/26',
        deferredBalance: 0,
        prepaymentPenalty: false
      },

      // Monthly fixed expenses
      expenses: {
        'Mortgage': 2532,
        'Student Loan 1': 561,
        'Student Loan 2': 153,
        'PSE&G': 347,
        'American Water': 160,
        'USAA Insurance': 207,
        'Xfinity': 61,
        'Life Insurance': 63,
        'Schwab Investment': 300,
        'Cell Phones': 173
      },

      // Emergency fund
      emergencyFund: { current: 0, target: 25000 },

      // Pre-seed document context from uploaded statements
      documents: [
        {
          name: 'Chase Sapphire Reserve Statement (Feb 2026)',
          uploadDate: '02/05/2026',
          type: 'Credit Card Statement',
          summary: 'Balance: $29,473.80, Interest: $525.84, Min: $1,941.68, Due: 02/28, 39,332 UR pts, 6 active Pay Over Time plans totaling $2,823.73',
          extractedData: {
            cardName: 'Chase Sapphire Reserve',
            balance: 29473.80,
            minimumPayment: 1941.68,
            apr: 24.99,
            interestCharged: 525.84,
            creditLimit: 29400,
            dueDate: '02/28',
            previousBalance: 30064.44,
            payments: 1675.00,
            purchases: 1084.36,
            transactionCount: 47,
            spendingByCategory: {
              'Dining': 312.45,
              'Groceries': 187.23,
              'Gas/Fuel': 89.50,
              'Medical/Health': 156.00,
              'Delivery/DoorDash': 134.67,
              'Parking': 47.00,
              'Entertainment': 62.00,
              'Shopping': 45.51,
              'Other': 50.00
            }
          }
        },
        {
          name: 'Chase Amazon Prime Visa Statement (Jan 2026)',
          uploadDate: '02/05/2026',
          type: 'Credit Card Statement',
          summary: 'Balance: $9,475.36, Interest: $170.85, Min: $265.00, Due: 02/20, 3,462 reward pts ($34.62)',
          extractedData: {
            cardName: 'Chase Amazon Prime Visa',
            balance: 9475.36,
            minimumPayment: 265.00,
            apr: 22.74,
            interestCharged: 170.85,
            creditLimit: 19900,
            dueDate: '02/20'
          }
        },
        {
          name: 'RenoFi HELOC Terms',
          uploadDate: '02/05/2026',
          type: 'Loan Terms',
          summary: '$300,000 Fixed Rate HELOC at 7.625%, 2yr draw / 20yr repayment, Est. $2,347.13/mo at full draw, Status: Pursuing',
          extractedData: {
            lender: 'RenoFi',
            amount: 300000,
            rate: 7.625,
            drawPeriod: 2,
            repayment: 20,
            monthlyPayment: 2347.13,
            type: 'Fixed Rate'
          }
        },
        {
          name: 'Freedom Mortgage Statement (Feb 2026)',
          uploadDate: '02/05/2026',
          type: 'Mortgage Statement',
          summary: 'Loan #0146338439, Balance: $309,693.86, Rate: 1.750%, Payment: $2,532.22/mo (P: $824.97, I: $451.64, Escrow: $1,255.61), Due: 03/01/26, AutoPay enabled, No prepayment penalty',
          extractedData: {
            lender: 'Freedom Mortgage',
            loanNumber: '0146338439',
            balance: 309693.86,
            rate: 1.75,
            monthlyPayment: 2532.22,
            principal: 824.97,
            interest: 451.64,
            escrow: 1255.61,
            escrowBalance: 3286.97,
            nextDueDate: '03/01/26',
            lateFee: 101.28,
            lateFeeAfter: '03/16/26',
            autopay: true,
            prepaymentPenalty: false,
            deferredBalance: 0,
            ytdPrincipal: 1646.34,
            ytdInterest: 906.88,
            ytdEscrow: 2511.22,
            ytdTotal: 5064.44,
            stmtDate: '02/02/26',
            lastPayment: { date: '02/02/26', amount: 2532.22, principal: 823.77, interest: 452.84, escrow: 1255.61 },
            taxDisbursement: { date: '01/27/26', amount: 3034.15 }
          }
        }
      ]
      };
    }

    function formatCurrency(num) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('tab-active');
        el.classList.add('bg-gray-700');
      });
      document.getElementById('content-' + tabName).classList.remove('hidden');
      document.getElementById('tab-' + tabName).classList.add('tab-active');
      document.getElementById('tab-' + tabName).classList.remove('bg-gray-700');
    }

    // ===== CALCULATIONS =====
    function getTotalIncome() {
      return (data.income.person1 || 0) + (data.income.person2 || 0) + (data.income.other1 || 0) + (data.income.other2 || 0);
    }

    function getTotalExpenses() {
      return Object.values(data.expenses).reduce((a, b) => a + b, 0);
    }

    function getCreditCardMinimums() {
      return data.creditCards.reduce((a, c) => a + (c.minimum || 0), 0);
    }

    function getHelocInterest() {
      return (data.heloc.drawn * (data.heloc.rate / 100)) / 12;
    }

    function getTotalObligations() {
      return getTotalExpenses() + getCreditCardMinimums() + getHelocInterest();
    }

    function getMonthlySurplus() {
      return getTotalIncome() - getTotalObligations();
    }

    function getTotalCreditCardDebt() {
      return data.creditCards.reduce((a, c) => a + (c.balance || 0), 0);
    }

    function getTotalStudentLoans() {
      return data.studentLoans.reduce((a, l) => a + (l.balance || 0), 0);
    }

    function getRenovationSpent() {
      return Object.values(data.renovation.categories).reduce((a, c) => a + c.spent, 0);
    }

    // ===== UI UPDATES =====
    function updateDashboard() {
      const income = getTotalIncome();
      const surplus = getMonthlySurplus();
      const ccDebt = getTotalCreditCardDebt();
      const slDebt = getTotalStudentLoans();

      document.getElementById('stat-income').textContent = formatCurrency(income);
      document.getElementById('stat-income-breakdown').textContent = 
        `${p1()}: ${formatCurrency(data.income.person1)} â€¢ ${p2()}: ${formatCurrency(data.income.person2)} â€¢ ${data.incomeLabels?.other1 || 'Benefits'}: ${formatCurrency(data.income.other1)}`;
      
      const surplusEl = document.getElementById('stat-surplus');
      surplusEl.textContent = formatCurrency(surplus);
      surplusEl.className = surplus >= 0 ? 'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-red-400';

      document.getElementById('stat-debt').textContent = formatCurrency(ccDebt + slDebt + data.heloc.drawn);
      document.getElementById('stat-emergency').textContent = formatCurrency(data.emergencyFund.current);

      updateCharts();
    }

    function updateRenovationTab() {
      const helocPct = (data.heloc.drawn / data.heloc.total) * 100;
      document.getElementById('heloc-drawn-display').textContent = `${formatCurrency(data.heloc.drawn)} / ${formatCurrency(data.heloc.total)}`;
      document.getElementById('heloc-progress').style.width = helocPct + '%';
      document.getElementById('heloc-rate-display').textContent = `${data.heloc.rate}%`;
      document.getElementById('heloc-interest-display').textContent = `Current Monthly Interest: ${formatCurrency(getHelocInterest())}`;
      document.getElementById('heloc-lender-display').textContent = data.heloc.lender || 'Not set';
      document.getElementById('heloc-draw-period-display').textContent = `${data.heloc.drawPeriodYears || 2} years`;
      document.getElementById('heloc-repay-display').textContent = `${data.heloc.repaymentYears || 20} years`;
      const estPayment = data.heloc.monthlyPayment || 0;
      const drawRatio = data.heloc.total > 0 ? data.heloc.drawn / data.heloc.total : 0;
      document.getElementById('heloc-monthly-payment-display').textContent = data.heloc.drawn > 0 
        ? `Est. Monthly Payment: ${formatCurrency(estPayment * drawRatio)}` 
        : `Est. Monthly Payment: ${estPayment > 0 ? formatCurrency(estPayment) + ' (at full draw)' : 'Not set'}`;
      const badge = document.getElementById('heloc-status-badge');
      if (badge) badge.textContent = data.heloc.status || 'Not Started';

      const spent = getRenovationSpent();
      const renoPct = (spent / data.renovation.budget) * 100;
      document.getElementById('reno-total-display').textContent = `${formatCurrency(spent)} / ${formatCurrency(data.renovation.budget)}`;
      document.getElementById('reno-progress').style.width = renoPct + '%';

      const categoryList = document.getElementById('category-list');
      categoryList.innerHTML = '';
      for (const [name, cat] of Object.entries(data.renovation.categories)) {
        const pct = cat.budget > 0 ? (cat.spent / cat.budget) * 100 : 0;
        const color = pct > 100 ? 'bg-red-500' : pct > 80 ? 'bg-yellow-500' : 'bg-green-500';
        categoryList.innerHTML += `
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span>${name}</span>
              <span class="text-gray-400">${formatCurrency(cat.spent)} / ${formatCurrency(cat.budget)}</span>
            </div>
            <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
              <div class="h-full ${color} progress-bar" style="width: ${Math.min(pct, 100)}%"></div>
            </div>
          </div>
        `;
      }

      const expenseList = document.getElementById('expense-list');
      expenseList.innerHTML = '';
      const recentExpenses = [...data.renovation.expenses].reverse().slice(0, 20);
      if (recentExpenses.length === 0) {
        expenseList.innerHTML = '<p class="text-gray-500 text-sm">No expenses recorded yet</p>';
      } else {
        recentExpenses.forEach((exp, idx) => {
          expenseList.innerHTML += `
            <div class="flex justify-between items-center py-2 border-b border-gray-700">
              <div>
                <span class="font-medium">${exp.category}</span>
                <span class="text-gray-500 text-sm ml-2">${exp.note || ''}</span>
                <span class="text-gray-600 text-xs ml-2">${new Date(exp.date).toLocaleDateString()}</span>
              </div>
              <span class="text-green-400">${formatCurrency(exp.amount)}</span>
            </div>
          `;
        });
      }
    }

    function updateDebtsTab() {
      const ccList = document.getElementById('credit-card-list');
      ccList.innerHTML = '';
      if (data.creditCards.length === 0) {
        ccList.innerHTML = '<p class="text-gray-500 text-sm">No credit cards added. Click "+ Add Card" to add one.</p>';
      } else {
        data.creditCards.forEach((card, idx) => {
          const utilization = card.limit ? ((card.balance / card.limit) * 100).toFixed(0) : 0;
          const utilColor = utilization > 90 ? 'text-red-400' : utilization > 70 ? 'text-orange-400' : utilization > 30 ? 'text-yellow-400' : 'text-green-400';
          const overLimit = card.limit && card.balance > card.limit;
          ccList.innerHTML += `
            <div class="bg-gray-750 rounded-lg p-4 border border-gray-600">
              <div class="flex justify-between items-center mb-2">
                <span class="font-medium text-white">${card.name}</span>
                <span class="text-orange-400 font-bold text-lg">${formatCurrency(card.balance)}</span>
              </div>
              <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-400 mb-2">
                <span>APR: <span class="text-gray-200">${card.apr}%</span></span>
                <span>Min Payment: <span class="text-gray-200">${formatCurrency(card.minimum)}</span></span>
                ${card.limit ? `<span>Credit Limit: <span class="text-gray-200">${formatCurrency(card.limit)}</span></span>` : ''}
                ${card.limit ? `<span>Utilization: <span class="${utilColor} font-medium">${utilization}%</span>${overLimit ? ' âš ï¸ OVER LIMIT' : ''}</span>` : ''}
                ${card.dueDate ? `<span>Due Date: <span class="text-gray-200">${card.dueDate}</span></span>` : ''}
                ${card.lastInterest ? `<span>Last Interest: <span class="text-red-400">${formatCurrency(card.lastInterest)}</span></span>` : ''}
                ${card.autopay ? '<span class="text-green-400">âœ“ AutoPay ON</span>' : '<span class="text-yellow-400">âš  No AutoPay</span>'}
                ${card.rewards ? `<span>Rewards: <span class="text-blue-300">${card.rewards}</span></span>` : ''}
              </div>
              ${card.limit ? `<div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full ${overLimit ? 'bg-red-500' : utilization > 70 ? 'bg-orange-500' : 'bg-blue-500'} progress-bar" style="width: ${Math.min(utilization, 100)}%"></div>
              </div>` : ''}
              <div class="text-xs text-gray-600 mt-2 flex justify-between">
                ${card.lastStmtDate ? `<span>Stmt: ${card.lastStmtDate}</span>` : ''}
                <button onclick="removeCreditCard(${idx})" class="text-red-400 hover:text-red-300">Remove</button>
              </div>
            </div>
          `;
        });
      }
      document.getElementById('total-cc-debt').textContent = formatCurrency(getTotalCreditCardDebt());
      const totalInterest = data.creditCards.reduce((a, c) => a + (c.lastInterest || 0), 0);
      document.getElementById('total-cc-interest').textContent = formatCurrency(totalInterest) + '/mo';
      document.getElementById('total-cc-minimums').textContent = formatCurrency(getCreditCardMinimums()) + '/mo';

      const slList = document.getElementById('student-loan-list');
      slList.innerHTML = '';
      data.studentLoans.forEach(loan => {
        slList.innerHTML += `
          <div class="bg-gray-750 rounded-lg p-3 border border-gray-600">
            <div class="flex justify-between items-center">
              <span class="font-medium">${loan.name}</span>
              <span class="text-purple-400 font-bold">${loan.balance > 0 ? formatCurrency(loan.balance) : 'Balance TBD'}</span>
            </div>
            <div class="text-xs text-gray-500 mt-1">
              ${loan.rate > 0 ? loan.rate + '% APR â€¢ ' : ''}Payment: ${formatCurrency(loan.payment)}/mo
            </div>
          </div>
        `;
      });
      document.getElementById('total-student-loans').textContent = formatCurrency(getTotalStudentLoans());

      const priorityList = document.getElementById('debt-priority-list');
      const allDebts = [
        ...data.creditCards.map(c => ({ name: c.name, balance: c.balance, rate: c.apr, type: 'CC' })),
        ...data.studentLoans.filter(l => l.balance > 0).map(l => ({ name: l.name, balance: l.balance, rate: l.rate, type: 'SL' }))
      ].sort((a, b) => b.rate - a.rate);
      
      priorityList.innerHTML = '';
      if (allDebts.length === 0) {
        priorityList.innerHTML = '<p class="text-gray-500 text-sm">Add your debts to see a prioritized payoff order.</p>';
      } else {
        allDebts.forEach((debt, idx) => {
          priorityList.innerHTML += `
            <div class="flex justify-between items-center py-2 px-3 bg-gray-750 rounded-lg">
              <div class="flex items-center gap-2">
                <span class="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold">${idx + 1}</span>
                <span>${debt.name}</span>
              </div>
              <div class="text-right">
                <div class="font-bold">${formatCurrency(debt.balance)}</div>
                <div class="text-xs text-gray-500">${debt.rate}% APR</div>
              </div>
            </div>
          `;
        });
      }

      // Mortgage display
      document.getElementById('mortgage-payment').textContent = formatCurrency(data.mortgage.payment);
      document.getElementById('mortgage-balance').textContent = data.mortgage.balance > 0 ? formatCurrency(data.mortgage.balance) : 'TBD';
      document.getElementById('mortgage-rate').textContent = data.mortgage.rate > 0 ? data.mortgage.rate + '%' : 'TBD';
      document.getElementById('mortgage-principal').textContent = data.mortgage.principalPaid ? formatCurrency(data.mortgage.principalPaid) : 'â€”';
      document.getElementById('mortgage-interest').textContent = data.mortgage.interestPaid ? formatCurrency(data.mortgage.interestPaid) : 'â€”';
      document.getElementById('mortgage-escrow').textContent = data.mortgage.escrowPaid ? formatCurrency(data.mortgage.escrowPaid) : 'â€”';
      document.getElementById('mortgage-due-info').textContent = data.mortgage.nextDueDate ? `Due: ${data.mortgage.nextDueDate}` : '';
      document.getElementById('mortgage-autopay-info').textContent = data.mortgage.autopay ? 'âœ… AutoPay' : '';
      document.getElementById('mortgage-loan-info').textContent = data.mortgage.loanNumber ? `Loan #${data.mortgage.loanNumber}` : '';
      document.getElementById('mortgage-title').textContent = `ğŸ¡ Mortgage${data.profile?.mortgageLender ? ' (' + data.profile.mortgageLender + ')' : ''}`;
    }

    function updateExpensesTab() {
      const list = document.getElementById('fixed-expense-list');
      list.innerHTML = '';
      for (const [name, amount] of Object.entries(data.expenses)) {
        list.innerHTML += `
          <div class="flex justify-between items-center py-2 border-b border-gray-700">
            <span>${name}</span>
            <span class="font-medium">${formatCurrency(amount)}</span>
          </div>
        `;
      }
      document.getElementById('total-fixed-expenses').textContent = formatCurrency(getTotalExpenses());

      const select = document.getElementById('edit-expense-name');
      select.innerHTML = '';
      for (const name of Object.keys(data.expenses)) {
        select.innerHTML += `<option value="${name}">${name}</option>`;
      }
    }

    function updateGoalsTab() {
      const pct = (data.emergencyFund.current / data.emergencyFund.target) * 100;
      document.getElementById('emergency-progress-text').textContent = 
        `${formatCurrency(data.emergencyFund.current)} / ${formatCurrency(data.emergencyFund.target)}`;
      document.getElementById('emergency-progress').style.width = Math.min(pct, 100) + '%';
      
      const surplus = getMonthlySurplus();
      const remaining = data.emergencyFund.target - data.emergencyFund.current;
      if (surplus > 0 && remaining > 0) {
        const months = Math.ceil(remaining / surplus);
        document.getElementById('emergency-eta').textContent = 
          `At current surplus of ${formatCurrency(surplus)}/mo: ~${months} months to goal`;
      } else if (remaining <= 0) {
        document.getElementById('emergency-eta').textContent = 'ğŸ‰ Goal reached!';
      } else {
        document.getElementById('emergency-eta').textContent = 'Increase surplus to make progress';
      }

      // Render goals
      const goalsList = document.getElementById('goals-list');
      if (!data.goals) data.goals = [];
      if (data.goals.length === 0) {
        goalsList.innerHTML = '<p class="text-gray-500 text-sm">No goals set yet. Open the chat and say things like:<br>â€¢ "Set a goal to pay off the Sapphire in 12 months"<br>â€¢ "I want to save $500/month for emergencies"<br>â€¢ "Set a monthly debt payoff goal of $2,000"</p>';
      } else {
        goalsList.innerHTML = '';
        data.goals.forEach((goal, idx) => {
          const progress = goal.target > 0 ? Math.min(((goal.current || 0) / goal.target) * 100, 100) : 0;
          const statusColor = goal.status === 'completed' ? 'bg-green-600' : goal.status === 'on-track' ? 'bg-blue-600' : 'bg-yellow-600';
          goalsList.innerHTML += `
            <div class="bg-gray-750 rounded-lg p-4 border border-gray-600">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <span class="font-medium text-white">${goal.name}</span>
                  <span class="text-xs ${statusColor} text-white px-2 py-0.5 rounded-full ml-2">${goal.status || 'active'}</span>
                </div>
                <button onclick="removeGoal(${idx})" class="text-red-400 hover:text-red-300 text-xs">âœ•</button>
              </div>
              ${goal.description ? `<p class="text-xs text-gray-400 mb-2">${goal.description}</p>` : ''}
              <div class="grid grid-cols-2 gap-2 text-xs text-gray-400 mb-2">
                ${goal.monthlyAmount ? `<span>Monthly: <span class="text-gray-200">${formatCurrency(goal.monthlyAmount)}</span></span>` : ''}
                ${goal.target ? `<span>Target: <span class="text-gray-200">${formatCurrency(goal.target)}</span></span>` : ''}
                ${goal.deadline ? `<span>By: <span class="text-gray-200">${goal.deadline}</span></span>` : ''}
                ${goal.months ? `<span>Timeline: <span class="text-gray-200">${goal.months} months</span></span>` : ''}
              </div>
              ${goal.target ? `<div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-green-600 to-emerald-400 progress-bar" style="width: ${progress}%"></div>
              </div>
              <div class="text-xs text-gray-500 mt-1">${formatCurrency(goal.current || 0)} of ${formatCurrency(goal.target)} (${progress.toFixed(0)}%)</div>` : ''}
              <div class="text-xs text-gray-600 mt-1">Set: ${goal.createdDate || 'Unknown'}</div>
            </div>
          `;
        });
      }

      // Render decisions log
      const decisionsLog = document.getElementById('decisions-log');
      if (!data.chatLog) data.chatLog = [];
      const decisions = data.chatLog.filter(l => l.type === 'decision');
      if (decisions.length === 0) {
        decisionsLog.innerHTML = '<p class="text-gray-500 text-sm">No decisions logged yet. The chat assistant will record key decisions here automatically.</p>';
      } else {
        decisionsLog.innerHTML = '';
        decisions.slice(-20).reverse().forEach(d => {
          decisionsLog.innerHTML += `
            <div class="bg-gray-750 rounded-lg p-3 border border-gray-600">
              <div class="flex justify-between">
                <span class="text-sm text-white">${d.text}</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">${d.date || 'Unknown'} ${d.by ? 'â€¢ ' + d.by : ''}</div>
            </div>
          `;
        });
      }
    }

    function removeGoal(idx) {
      if (confirm('Remove this goal?')) {
        data.goals.splice(idx, 1);
        saveData();
        autoSyncToSheets('goal-removed');
        updateAll();
      }
    }

    function clearDecisions() {
      if (confirm('Clear all decisions from the log?')) {
        data.chatLog = data.chatLog.filter(l => l.type !== 'decision');
        saveData();
        autoSyncToSheets('decisions-cleared');
        updateAll();
      }
    }

    // ===== CHATBOT WRITE HELPERS =====
    function addGoal(goal) {
      if (!data.goals) data.goals = [];
      goal.createdDate = new Date().toLocaleDateString();
      goal.status = goal.status || 'active';
      goal.current = goal.current || 0;
      data.goals.push(goal);
      saveData();
      autoSyncToSheets('goal-added');
      updateAll();
    }

    function logDecision(text, by) {
      if (!data.chatLog) data.chatLog = [];
      data.chatLog.push({
        type: 'decision',
        text: text,
        date: new Date().toLocaleDateString(),
        by: by || 'Chat Assistant'
      });
      saveData();
      autoSyncToSheets('decision-logged');
    }

    function autoSyncToSheets(reason) {
      const url = getSheetsUrl();
      if (!url) return; // No sheets configured, skip
      data.lastUpdated = new Date().toISOString();
      data.lastUpdatedBy = reason || 'auto-sync';
      fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'save', data: data })
      }).catch(() => {}); // Silent fail
    }

    // ===== DOCUMENT UPLOAD & PARSING =====
    
    function showUploadStatus(text) {
      const el = document.getElementById('upload-status');
      document.getElementById('upload-status-text').textContent = text;
      el.classList.remove('hidden');
    }
    function hideUploadStatus() { document.getElementById('upload-status').classList.add('hidden'); }

    async function handleChatFileUpload(event) {
      const files = event.target.files;
      if (!files.length) return;
      
      for (const file of files) {
        showUploadStatus(`ğŸ“„ Processing: ${file.name}...`);
        addChatMessage(`ğŸ“ Uploading: ${file.name}`, 'user');
        
        try {
          const text = await extractFileText(file);
          if (!text || text.trim().length < 10) {
            addChatMessage(`âš ï¸ Couldn't extract usable text from ${file.name}. Try a CSV or TXT version, or type the key numbers into the chat.`, 'assistant');
            hideUploadStatus();
            continue;
          }
          
          const parsed = parseFinancialDocument(text, file.name);
          
          if (!data.documents) data.documents = [];
          const doc = {
            name: file.name,
            uploadDate: new Date().toLocaleDateString(),
            type: parsed.type,
            summary: parsed.summary,
            extractedData: parsed.data,
            rawTextPreview: text.substring(0, 500)
          };
          const existingIdx = data.documents.findIndex(d => d.name === file.name);
          if (existingIdx >= 0) data.documents[existingIdx] = doc;
          else data.documents.push(doc);
          
          // Keep documents list manageable (last 20)
          if (data.documents.length > 20) data.documents = data.documents.slice(-20);
          
          let response = '';
          if (parsed.applied.length > 0) {
            response = `âœ… Processed "${file.name}" â€” ${parsed.type}\n\n`;
            response += `ğŸ“Š Extracted & Applied:\n`;
            parsed.applied.forEach(a => { response += `â€¢ ${a}\n`; });
            if (parsed.data.spendingByCategory) {
              response += `\nğŸ’³ Spending Breakdown:\n`;
              for (const [cat, amt] of Object.entries(parsed.data.spendingByCategory)) {
                response += `â€¢ ${cat}: ${formatCurrency(amt)}\n`;
              }
            }
            if (parsed.summary) response += `\nğŸ“ ${parsed.summary}`;
          } else {
            response = `ğŸ“„ Stored "${file.name}" as context â€” ${parsed.type}\n\n`;
            if (parsed.data && Object.keys(parsed.data).length > 0) {
              response += `ğŸ“Š Extracted:\n`;
              for (const [key, val] of Object.entries(parsed.data)) {
                if (key === 'spendingByCategory' || key === 'transactions' || key === 'headers') continue;
                response += `â€¢ ${key}: ${typeof val === 'number' ? formatCurrency(val) : val}\n`;
              }
            }
            response += `\nThis is now available as context when you ask me questions.`;
          }
          
          logDecision(`Document uploaded: ${file.name} (${parsed.type})`);
          saveData();
          autoSyncToSheets('document-upload');
          updateAll();
          addChatMessage(response, 'assistant');
          
        } catch (err) {
          addChatMessage(`âŒ Error processing ${file.name}: ${err.message}`, 'assistant');
        }
        hideUploadStatus();
      }
      event.target.value = '';
    }

    async function extractFileText(file) {
      const name = file.name.toLowerCase();
      if (name.endsWith('.csv') || name.endsWith('.txt') || name.endsWith('.json') || file.type.startsWith('text/')) {
        return await file.text();
      }
      if (name.endsWith('.pdf') || file.type === 'application/pdf') {
        return await extractPdfText(file);
      }
      if (file.type.startsWith('image/')) {
        return `[Image: ${file.name}, ${(file.size/1024).toFixed(0)}KB. For best results, upload a text/CSV version or type the key numbers in chat.]`;
      }
      try { return await file.text(); } catch { return ''; }
    }

    async function extractPdfText(file) {
      try {
        const buffer = await file.arrayBuffer();
        const raw = new TextDecoder('utf-8', {fatal:false}).decode(new Uint8Array(buffer));
        const chunks = [];
        const matches = raw.match(/\(([^)]{2,})\)/g);
        if (matches) matches.forEach(m => {
          const c = m.slice(1,-1).replace(/\\[nr]/g,' ').replace(/\\\(/g,'(').replace(/\\\)/g,')').replace(/[^\x20-\x7E\n]/g,' ').trim();
          if (c.length > 1) chunks.push(c);
        });
        const text = chunks.join(' ').replace(/\s+/g,' ');
        return text.length > 20 ? text : `[PDF: ${file.name} â€” could not extract text. Try CSV/TXT or type key numbers in chat.]`;
      } catch { return ''; }
    }

    function parseFinancialDocument(text, fileName) {
      const t = text.toLowerCase();
      const result = { type: 'Unknown Document', data: {}, applied: [], summary: '' };
      
      // CREDIT CARD STATEMENT
      if (t.includes('new balance') || t.includes('minimum payment') || t.includes('account summary') || t.includes('payment due date')) {
        result.type = 'Credit Card Statement';
        const grab = (re) => { const m = text.match(re); return m ? parseFloat(m[1].replace(/,/g,'')) : null; };
        const grabStr = (re) => { const m = text.match(re); return m ? m[1].trim() : null; };
        
        result.data.balance = grab(/new\s*balance[:\s]*\$?([\d,]+\.?\d*)/i);
        result.data.minimumPayment = grab(/minimum\s*payment[^:]*[:\s]*\$?([\d,]+\.?\d*)/i);
        result.data.dueDate = grabStr(/(?:payment\s*)?due\s*date[:\s]*([\d\/]+)/i);
        result.data.apr = grab(/purchases?\s+(\d+\.\d+)%/i) || grab(/([\d.]+)%\s*\(v\)/i);
        result.data.interestCharged = grab(/(?:interest\s*charged?|purchase\s*interest)[:\s]*\+?\$?([\d,]+\.?\d*)/i);
        result.data.creditLimit = grab(/credit\s*(?:access\s*)?line[:\s]*\$?([\d,]+)/i);
        result.data.previousBalance = grab(/previous\s*balance[:\s]*\$?([\d,]+\.?\d*)/i);
        result.data.purchases = grab(/purchases[:\s]*\+?\$?([\d,]+\.?\d*)/i);
        
        // Detect card
        let cardName = 'Unknown Card';
        if (t.includes('sapphire')) cardName = 'Chase Sapphire Reserve';
        else if (t.includes('amazon') || t.includes('prime visa')) cardName = 'Chase Amazon Prime Visa';
        else if (t.includes('freedom flex') || t.includes('freedom unlimited')) cardName = 'Chase Freedom';
        else if (t.includes('discover')) cardName = 'Discover';
        else if (t.includes('amex') || t.includes('american express')) cardName = 'American Express';
        result.data.cardName = cardName;
        
        // Auto-apply
        const match = data.creditCards.find(c => c.name === cardName || c.name.toLowerCase().includes(cardName.toLowerCase().split(' ').pop()));
        if (match && result.data.balance) {
          match.balance = result.data.balance;
          if (result.data.minimumPayment) match.minimum = result.data.minimumPayment;
          if (result.data.apr) match.apr = result.data.apr;
          if (result.data.dueDate) match.dueDate = result.data.dueDate;
          if (result.data.interestCharged) match.lastInterest = result.data.interestCharged;
          if (result.data.creditLimit) match.limit = result.data.creditLimit;
          match.lastStmtDate = new Date().toLocaleDateString();
          result.applied.push(`Updated ${match.name}: balance â†’ ${formatCurrency(result.data.balance)}`);
          if (result.data.interestCharged) result.applied.push(`Interest: ${formatCurrency(result.data.interestCharged)}`);
          if (result.data.dueDate) result.applied.push(`Due: ${result.data.dueDate}`);
        } else if (result.data.balance) {
          data.creditCards.push({
            name: cardName, balance: result.data.balance, apr: result.data.apr || 0,
            minimum: result.data.minimumPayment || 0, limit: result.data.creditLimit || 0,
            dueDate: result.data.dueDate || '', lastInterest: result.data.interestCharged || 0,
            lastStmtDate: new Date().toLocaleDateString()
          });
          result.applied.push(`Added new card: ${cardName} â€” ${formatCurrency(result.data.balance)}`);
        }
        
        // Categorize transactions
        const txns = extractTransactions(text);
        if (txns.length > 0) {
          result.data.transactionCount = txns.length;
          result.data.spendingByCategory = categorizeTransactions(txns);
        }
        
        result.summary = `${cardName}: ${formatCurrency(result.data.balance||0)} balance, ${formatCurrency(result.data.interestCharged||0)} interest`;
      }
      
      // UTILITY / BILL
      else if (t.includes('amount due') || t.includes('billing statement') || t.includes('pse&g') || t.includes('xfinity') || t.includes('comcast') || t.includes('water bill')) {
        result.type = 'Utility / Bill';
        const amtM = text.match(/(?:amount|total|balance)\s*due[:\s]*\$?([\d,]+\.?\d*)/i);
        if (amtM) result.data.amountDue = parseFloat(amtM[1].replace(/,/g,''));
        
        let utilName = 'Unknown Bill';
        if (t.includes('pse&g') || t.includes('pseg')) utilName = 'PSE&G';
        else if (t.includes('american water')) utilName = 'American Water';
        else if (t.includes('xfinity') || t.includes('comcast')) utilName = 'Xfinity';
        else if (t.includes('usaa')) utilName = 'USAA Insurance';
        result.data.billName = utilName;
        
        if (result.data.amountDue && data.expenses[utilName]) {
          data.expenses[utilName] = result.data.amountDue;
          result.applied.push(`Updated ${utilName}: ${formatCurrency(result.data.amountDue)}/mo`);
        }
        result.summary = `${utilName}: ${formatCurrency(result.data.amountDue||0)}`;
      }
      
      // MORTGAGE
      else if (t.includes('mortgage') || t.includes('freedom mortgage') || t.includes('principal balance') || t.includes('escrow')) {
        result.type = 'Mortgage Statement';
        const balM = text.match(/(?:principal|unpaid)\s*balance[:\s]*\$?([\d,]+\.?\d*)/i);
        const rateM = text.match(/(?:interest\s*)?rate[:\s]*([\d.]+)%/i);
        if (balM) { result.data.balance = parseFloat(balM[1].replace(/,/g,'')); data.mortgage.balance = result.data.balance; result.applied.push(`Mortgage balance: ${formatCurrency(result.data.balance)}`); }
        if (rateM) { result.data.rate = parseFloat(rateM[1]); data.mortgage.rate = result.data.rate; result.applied.push(`Mortgage rate: ${result.data.rate}%`); }
        result.summary = `Mortgage: ${formatCurrency(result.data.balance||0)}, ${result.data.rate||'?'}%`;
      }
      
      // PAY STUB
      else if (t.includes('gross pay') || t.includes('net pay') || t.includes('earnings') || t.includes('pay stub') || t.includes('ytd')) {
        result.type = 'Pay Stub';
        const grossM = text.match(/gross\s*pay[:\s]*\$?([\d,]+\.?\d*)/i);
        const netM = text.match(/net\s*pay[:\s]*\$?([\d,]+\.?\d*)/i);
        if (grossM) result.data.grossPay = parseFloat(grossM[1].replace(/,/g,''));
        if (netM) result.data.netPay = parseFloat(netM[1].replace(/,/g,''));
        result.summary = `Pay: Gross ${formatCurrency(result.data.grossPay||0)}, Net ${formatCurrency(result.data.netPay||0)}`;
      }
      
      // CSV
      else if (fileName.endsWith('.csv')) {
        result.type = 'CSV Data';
        const lines = text.trim().split('\n');
        result.data.headers = lines[0].split(',').map(h => h.trim().replace(/"/g,''));
        result.data.rowCount = lines.length - 1;
        result.summary = `CSV: ${result.data.rowCount} rows, columns: ${result.data.headers.join(', ')}`;
      }
      
      // GENERIC
      else {
        result.type = 'General Document';
        const amounts = text.match(/\$[\d,]+\.?\d*/g);
        if (amounts) {
          result.data.amountsFound = amounts.length;
          result.data.amounts = amounts.slice(0, 10).map(a => parseFloat(a.replace(/[$,]/g,'')));
        }
        result.summary = `Document: ${text.length} chars${amounts ? `, ${amounts.length} dollar amounts` : ''}`;
      }
      
      return result;
    }

    function extractTransactions(text) {
      const txns = [];
      const lines = text.split(/\n/);
      lines.forEach(line => {
        const m = line.match(/(\d{2}\/\d{2})\s+(.+?)\s+(\d+\.\d{2})\s*$/);
        if (m) txns.push({ date: m[1], merchant: m[2].trim(), amount: parseFloat(m[3]) });
      });
      return txns;
    }

    function categorizeTransactions(txns) {
      const cats = {};
      const rules = [
        ['Dining', /doordash|uber\s*eat|grubhub|restaurant|pizza|cafe|grill|starbucks|dunkin|chick-?fil|mcdonald|chickies|cava|wawa|two fish|brew|honey post|johnny long|ragazzi/i],
        ['Groceries', /shoprite|costco|wegmans|sprouts|trader joe|walmart|wal-?mart|target|instacart|whole food/i],
        ['Gas/Fuel', /fuel|gas|speedy|royal farm|7-?eleven|shell|wawa.*gas/i],
        ['Medical/Health', /barber|derm|pharmacy|walgreens|cvs|imaging|chir|heart.*paw|strive|doctor|dental/i],
        ['Parking', /parking|honk|laz park|premium park/i],
        ['Entertainment', /aquarium|lego|adventure|movie|concert|museum|zoo/i],
        ['Shopping', /dsw|ikea|ellaola|little sleep|amazon|chewy|mail room/i],
        ['Subscriptions', /xfinity|prime|netflix|spotify|hulu|disney|apple.*montessori/i],
        ['Transport', /uber|lyft|ezpass|transit/i]
      ];
      txns.forEach(t => {
        let matched = false;
        for (const [cat, re] of rules) {
          if (re.test(t.merchant)) { cats[cat] = (cats[cat]||0) + t.amount; matched = true; break; }
        }
        if (!matched) cats['Other'] = (cats['Other']||0) + t.amount;
      });
      return cats;
    }

    function getDocumentContext() {
      if (!data.documents || data.documents.length === 0) return '';
      let ctx = '\nUploaded docs: ';
      data.documents.forEach(doc => {
        ctx += `${doc.name} (${doc.type}): ${doc.summary}. `;
      });
      return ctx;
    }

    function updateSettingsTab() {
      document.getElementById('setting-p1-income').value = data.income.person1;
      document.getElementById('setting-p2-income').value = data.income.person2;
      document.getElementById('setting-va-income').value = data.income.other1;
      document.getElementById('setting-other-income').value = data.income.other2;
      // Dynamic labels
      document.getElementById('label-p1-income').textContent = `${p1()} Net Monthly${p1Emp()}`;
      document.getElementById('label-p2-income').textContent = `${p2()} Net Monthly${p2Emp()}`;
      if (data.heloc.lender) document.getElementById('heloc-settings-title').textContent = `ğŸ  HELOC Settings (${data.heloc.lender})`;
      document.getElementById('mortgage-title').textContent = `ğŸ¡ Mortgage${data.profile?.mortgageLender ? ' (' + data.profile.mortgageLender + ')' : ''}`;
      document.getElementById('setting-heloc-total').value = data.heloc.total;
      document.getElementById('setting-heloc-rate').value = data.heloc.rate;
      document.getElementById('setting-heloc-draw-period').value = data.heloc.drawPeriodYears;
      document.getElementById('setting-heloc-repay-period').value = data.heloc.repaymentYears || 20;
      document.getElementById('setting-heloc-payment').value = data.heloc.monthlyPayment || 2347.13;
      // Load saved Sheets URL
      const savedSheetsUrl = localStorage.getItem(SHEETS_URL_KEY) || '';
      document.getElementById('setting-sheets-url').value = savedSheetsUrl;
    }

    let cashFlowChart, renovationChart;

    function updateCharts() {
      const income = getTotalIncome();
      const expenses = getTotalObligations();
      const surplus = income - expenses;

      if (cashFlowChart) cashFlowChart.destroy();
      cashFlowChart = new Chart(document.getElementById('cashFlowChart'), {
        type: 'bar',
        data: {
          labels: ['Income', 'Expenses', 'Surplus'],
          datasets: [{
            data: [income, expenses, surplus],
            backgroundColor: ['#10b981', '#ef4444', surplus >= 0 ? '#3b82f6' : '#f59e0b']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { 
              beginAtZero: true,
              ticks: { color: '#9ca3af', callback: v => '$' + (v/1000) + 'k' },
              grid: { color: '#374151' }
            },
            x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
          }
        }
      });

      const spent = getRenovationSpent();
      const remaining = data.renovation.budget - spent;
      if (renovationChart) renovationChart.destroy();
      renovationChart = new Chart(document.getElementById('renovationChart'), {
        type: 'doughnut',
        data: {
          labels: ['Spent', 'Remaining'],
          datasets: [{
            data: [spent, Math.max(0, remaining)],
            backgroundColor: ['#10b981', '#374151']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#9ca3af' } }
          }
        }
      });
    }

    // ===== ACTIONS =====
    function addRenovationExpense() {
      const category = document.getElementById('quick-category').value;
      const amount = parseFloat(document.getElementById('quick-amount').value);
      const note = document.getElementById('quick-note').value;

      if (!amount || amount <= 0) return alert('Please enter a valid amount');

      data.renovation.categories[category].spent += amount;
      data.renovation.expenses.push({
        category,
        amount,
        note,
        date: new Date().toISOString()
      });

      saveData();
      document.getElementById('quick-amount').value = '';
      document.getElementById('quick-note').value = '';
      updateAll();
    }

    function addHelocDraw() {
      const amount = parseFloat(document.getElementById('heloc-draw-amount').value);
      const remaining = data.heloc.total - data.heloc.drawn;

      if (!amount || amount <= 0) return alert('Please enter a valid amount');
      if (amount > remaining) return alert(`Only ${formatCurrency(remaining)} available to draw`);

      data.heloc.drawn += amount;
      saveData();
      document.getElementById('heloc-draw-amount').value = '';
      updateAll();
    }

    function showAddDebtModal() {
      document.getElementById('add-debt-modal').classList.remove('hidden');
      document.getElementById('add-debt-modal').classList.add('flex');
    }

    function hideAddDebtModal() {
      document.getElementById('add-debt-modal').classList.add('hidden');
      document.getElementById('add-debt-modal').classList.remove('flex');
    }

    function addCreditCard() {
      const name = document.getElementById('new-card-name').value;
      const balance = parseFloat(document.getElementById('new-card-balance').value) || 0;
      const apr = parseFloat(document.getElementById('new-card-apr').value) || 0;
      const minimum = parseFloat(document.getElementById('new-card-minimum').value) || 0;
      const limit = parseFloat(document.getElementById('new-card-limit').value) || 0;
      const dueDate = document.getElementById('new-card-duedate').value || '';

      if (!name) return alert('Please enter a card name');

      const card = { name, balance, apr, minimum };
      if (limit) card.limit = limit;
      if (dueDate) card.dueDate = dueDate;
      data.creditCards.push(card);
      saveData();
      hideAddDebtModal();
      ['new-card-name','new-card-balance','new-card-apr','new-card-minimum','new-card-limit','new-card-duedate'].forEach(id => document.getElementById(id).value = '');
      updateAll();
    }

    function removeCreditCard(idx) {
      if (confirm('Remove this credit card?')) {
        data.creditCards.splice(idx, 1);
        saveData();
        updateAll();
      }
    }

    function updateExpense() {
      const name = document.getElementById('edit-expense-name').value;
      const amount = parseFloat(document.getElementById('edit-expense-amount').value);

      if (!amount && amount !== 0) return alert('Please enter an amount');

      data.expenses[name] = amount;
      saveData();
      document.getElementById('edit-expense-amount').value = '';
      updateAll();
    }

    function addToEmergencyFund() {
      const amount = parseFloat(document.getElementById('emergency-add').value);
      if (!amount || amount <= 0) return alert('Please enter a valid amount');

      data.emergencyFund.current += amount;
      saveData();
      document.getElementById('emergency-add').value = '';
      updateAll();
    }

    function saveIncomeSettings() {
      data.income.person1 = parseFloat(document.getElementById('setting-p1-income').value) || 0;
      data.income.person2 = parseFloat(document.getElementById('setting-p2-income').value) || 0;
      data.income.other1 = parseFloat(document.getElementById('setting-va-income').value) || 0;
      data.income.other2 = parseFloat(document.getElementById('setting-other-income').value) || 0;
      saveData();
      updateAll();
      alert('Income settings saved!');
    }

    function saveHelocSettings() {
      data.heloc.total = parseFloat(document.getElementById('setting-heloc-total').value) || 300000;
      data.heloc.rate = parseFloat(document.getElementById('setting-heloc-rate').value) || 7.625;
      data.heloc.drawPeriodYears = parseFloat(document.getElementById('setting-heloc-draw-period').value) || 2;
      data.heloc.repaymentYears = parseFloat(document.getElementById('setting-heloc-repay-period').value) || 20;
      data.heloc.monthlyPayment = parseFloat(document.getElementById('setting-heloc-payment').value) || 2347.13;
      saveData();
      updateAll();
      alert('HELOC settings saved!');
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'budget-export-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
    }

    function shareViaText() {
      const summary = generateSummary();
      if (navigator.share) {
        navigator.share({
          title: 'Budget Update',
          text: summary,
        }).catch(() => {});
      } else {
        const smsBody = encodeURIComponent(summary);
        window.open('sms:?&body=' + smsBody);
      }
    }

    function generateSummary() {
      const income = getTotalIncome();
      const ccDebt = getTotalCreditCardDebt();
      const surplus = getMonthlySurplus();
      let s = `ğŸ’° Budget Update (${new Date().toLocaleDateString()})\n\n`;
      s += `Monthly Income: ${formatCurrency(income)}\n`;
      s += `Monthly Surplus: ${formatCurrency(surplus)}\n`;
      s += `Credit Card Debt: ${formatCurrency(ccDebt)}\n`;
      data.creditCards.forEach(c => {
        s += `  â€¢ ${c.name}: ${formatCurrency(c.balance)} (${c.apr}%)\n`;
      });
      s += `HELOC Drawn: ${formatCurrency(data.heloc.drawn)} / ${formatCurrency(data.heloc.total)}\n`;
      s += `Emergency Fund: ${formatCurrency(data.emergencyFund.current)} / ${formatCurrency(data.emergencyFund.target)}\n`;
      if (data.profile?.appUrl) s += `\nOpen app: ${data.profile.appUrl}`;
      return s;
    }

    // ===== GOOGLE SHEETS SYNC =====
    const SHEETS_URL_KEY = 'dayBudgetSheetsUrl';

    function getSheetsUrl() {
      return document.getElementById('setting-sheets-url').value || localStorage.getItem(SHEETS_URL_KEY) || '';
    }

    function saveSheetsUrl() {
      const url = document.getElementById('setting-sheets-url').value;
      if (url) localStorage.setItem(SHEETS_URL_KEY, url);
    }

    async function syncToSheets() {
      const url = getSheetsUrl();
      if (!url) return alert('Please paste your Google Sheets Web App URL in Settings first.');
      saveSheetsUrl();

      const btn = event.target;
      btn.textContent = 'â³ Pushing...';
      btn.disabled = true;

      try {
        data.lastUpdated = new Date().toISOString();
        data.lastUpdatedBy = 'manual-push';
        saveData();

        const response = await fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action: 'save', data: data })
        });

        btn.textContent = 'âœ… Pushed!';
        setTimeout(() => { btn.textContent = 'â˜ï¸ Push to Sheets'; btn.disabled = false; }, 2000);
      } catch (err) {
        alert('Sync failed: ' + err.message);
        btn.textContent = 'â˜ï¸ Push to Sheets';
        btn.disabled = false;
      }
    }

    async function syncFromSheets() {
      const url = getSheetsUrl();
      if (!url) return alert('Please paste your Google Sheets Web App URL in Settings first.');
      saveSheetsUrl();

      const btn = event.target;
      btn.textContent = 'â³ Pulling...';
      btn.disabled = true;

      try {
        const response = await fetch(url + '?action=load&t=' + Date.now());
        const result = await response.json();

        if (result && result.data && typeof result.data === 'object' && result.data.income) {
          data = migrateData(result.data);
          saveData();
          updateAll();
          btn.textContent = 'âœ… Pulled!';
          const updated = data.lastUpdated ? new Date(data.lastUpdated).toLocaleString() : 'Unknown';
          setTimeout(() => { 
            btn.textContent = 'â¬‡ï¸ Pull from Sheets'; 
            btn.disabled = false;
            alert('Data synced! Last updated: ' + updated);
          }, 1000);
        } else {
          throw new Error('No data found in sheet');
        }
      } catch (err) {
        alert('Pull failed: ' + err.message + '\nMake sure the Sheets URL is correct.');
        btn.textContent = 'â¬‡ï¸ Pull from Sheets';
        btn.disabled = false;
      }
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          // Validate basic structure
          if (typeof imported !== 'object' || !imported.income || !imported.expenses) {
            throw new Error('Invalid budget data format');
          }
          data = migrateData(imported);
          saveData();
          updateAll();
          alert('Data imported successfully!');
        } catch (err) {
          alert('Error importing data: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    function resetData() {
      if (confirm('Are you sure you want to reset ALL data? This cannot be undone.')) {
        data = JSON.parse(JSON.stringify(defaultData));
        saveData();
        updateAll();
        alert('Data has been reset.');
      }
    }

    function updateAll() {
      // Update dynamic header
      document.getElementById('app-subtitle').textContent = subtitle();
      updateDashboard();
      updateRenovationTab();
      updateDebtsTab();
      updateExpensesTab();
      updateGoalsTab();
      updateSettingsTab();
    }

    // Initialize - load from persistent storage
    loadData();

    // Register service worker for offline PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/Day_budget/sw.js')
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.log('SW registration failed:', err));
    }

    // Handle PWA install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // Show install banner
      const banner = document.createElement('div');
      banner.id = 'install-banner';
      banner.className = 'fixed top-0 left-0 right-0 bg-blue-600 text-white px-4 py-3 flex items-center justify-between z-50';
      banner.innerHTML = `
        <span class="text-sm font-medium">ğŸ“± Install Budget Tracker as an app on your device!</span>
        <div class="flex gap-2">
          <button onclick="installPWA()" class="bg-white text-blue-600 px-3 py-1 rounded-lg text-sm font-bold">Install</button>
          <button onclick="document.getElementById('install-banner').remove()" class="text-blue-200 hover:text-white px-2">âœ•</button>
        </div>
      `;
      document.body.prepend(banner);
    });

    async function installPWA() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('Install outcome:', outcome);
      deferredPrompt = null;
      const banner = document.getElementById('install-banner');
      if (banner) banner.remove();
    }

    // ===== CHAT FUNCTIONALITY =====
    function toggleChat() {
      const panel = document.getElementById('chat-panel');
      const toggle = document.getElementById('chat-toggle');
      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        panel.classList.add('flex');
        toggle.classList.add('scale-0');
        document.getElementById('chat-input').focus();
      } else {
        panel.classList.add('hidden');
        panel.classList.remove('flex');
        toggle.classList.remove('scale-0');
      }
    }

    function handleChatKeypress(event) {
      if (event.key === 'Enter') {
        sendChatMessage();
      }
    }

    function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      addChatMessage(message, 'user');
      input.value = '';

      setTimeout(() => {
        const response = processQuestion(message);
        addChatMessage(response, 'assistant');
      }, 300);
    }

    function addChatMessage(text, role) {
      const container = document.getElementById('chat-messages');
      const isUser = role === 'user';
      const safeText = sanitize(text);
      
      const html = `
        <div class="flex gap-3 ${isUser ? 'flex-row-reverse' : ''}">
          <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${isUser ? 'bg-green-600' : 'bg-blue-600'}">
            ${isUser ? 
              '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>' : 
              '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>'
            }
          </div>
          <div class="max-w-[80%] rounded-xl px-4 py-2 ${isUser ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-100'}">
            <p class="text-sm whitespace-pre-wrap">${safeText}</p>
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', html);
      container.scrollTop = container.scrollHeight;
    }

    function processQuestion(question) {
      const q = question.toLowerCase();
      
      // ===== COMPUTED VALUES =====
      const income = getTotalIncome();
      const fixedExpenses = getTotalExpenses();
      const ccMinimums = getCreditCardMinimums();
      const helocInterest = getHelocInterest();
      const totalObligations = getTotalObligations();
      const surplus = getMonthlySurplus();
      const ccDebt = getTotalCreditCardDebt();
      const slDebt = getTotalStudentLoans();
      const totalDebt = ccDebt + slDebt + data.heloc.drawn;
      const renoSpent = getRenovationSpent();
      const renoRemaining = data.renovation.budget - renoSpent;
      const helocRemaining = data.heloc.total - data.heloc.drawn;
      const emergencyProgress = (data.emergencyFund.current / data.emergencyFund.target) * 100;
      const monthsToEmergency = surplus > 0 ? Math.ceil((data.emergencyFund.target - data.emergencyFund.current) / surplus) : Infinity;
      
      // Credit card interest costs
      const totalCCInterest = data.creditCards.reduce((a, c) => a + (c.lastInterest || (c.balance * c.apr / 100 / 12)), 0);
      const sapphire = data.creditCards.find(c => c.name.toLowerCase().includes('sapphire'));
      const amazon = data.creditCards.find(c => c.name.toLowerCase().includes('amazon'));
      
      // HELOC affordability
      const helocPayment = data.heloc.monthlyPayment || 2347.13;
      const helocDrawPeriod = data.heloc.drawPeriodYears || 2;
      const helocRepayment = data.heloc.repaymentYears || 20;
      const helocRate = data.heloc.rate || 7.625;
      const helocLender = data.heloc.lender || 'RenoFi';
      const surplusAfterHeloc = surplus - helocPayment;

      // ===== WRITE ACTIONS: GOAL SETTING =====
      
      // "Set a goal to pay off Sapphire in 12 months"
      if (q.includes('set') && q.includes('goal') || q.includes('i want to') || q.includes("let's") && (q.includes('goal') || q.includes('plan') || q.includes('target') || q.includes('save') || q.includes('pay'))) {
        
        // Pay off a specific card
        const cardMatch = q.match(/pay\s*off\s*(sapphire|amazon|credit|card)/i);
        const monthsMatch = q.match(/(\d+)\s*month/);
        const amountMatch = q.match(/\$?([\d,]+)/);
        
        if (cardMatch || (q.includes('pay') && (q.includes('sapphire') || q.includes('amazon')))) {
          const targetCard = q.includes('sapphire') ? sapphire : q.includes('amazon') ? amazon : null;
          if (targetCard) {
            const months = monthsMatch ? parseInt(monthsMatch[1]) : null;
            const monthlyNeeded = months ? targetCard.balance / months : null;
            
            let r = `ğŸ“ Let me build a payoff plan for the ${targetCard.name}:\n\n`;
            r += `Current balance: ${formatCurrency(targetCard.balance)}\n`;
            r += `Current minimum: ${formatCurrency(targetCard.minimum)}\n`;
            r += `Monthly interest: ~${formatCurrency(targetCard.lastInterest || (targetCard.balance * targetCard.apr / 100 / 12))}\n\n`;
            
            if (months) {
              const totalWithInterest = targetCard.balance * (1 + (targetCard.apr / 100 / 12 * months * 0.5)); // rough estimate
              const realMonthly = totalWithInterest / months;
              r += `To pay off in ${months} months: ~${formatCurrency(realMonthly)}/mo\n`;
              r += `Your surplus is ${formatCurrency(surplus)}/mo\n\n`;
              
              if (realMonthly <= surplus + targetCard.minimum) {
                r += `âœ… This is doable! I'll save this goal.\n`;
                addGoal({
                  name: `Pay off ${targetCard.name}`,
                  description: `Eliminate ${formatCurrency(targetCard.balance)} balance in ${months} months at ~${formatCurrency(realMonthly)}/mo`,
                  target: targetCard.balance,
                  current: 0,
                  monthlyAmount: realMonthly,
                  months: months,
                  category: 'debt-payoff'
                });
                logDecision(`Goal set: Pay off ${targetCard.name} (${formatCurrency(targetCard.balance)}) in ${months} months at ~${formatCurrency(realMonthly)}/mo`);
                r += `\nâœ… Goal saved to your Goals tab and synced to Google Sheets!`;
              } else {
                const realisticMonths = Math.ceil(targetCard.balance / (surplus * 0.8));
                r += `âš ï¸ That's tight â€” ${formatCurrency(realMonthly)}/mo vs your ${formatCurrency(surplus)} surplus.\n\n`;
                r += `A more realistic timeline: ~${realisticMonths} months putting 80% of surplus toward it.\n\n`;
                r += `Want me to save the ${realisticMonths}-month plan instead? Just say "yes, save that" or pick your own timeline.`;
              }
            } else {
              // No months specified â€” suggest options
              const fast = Math.ceil(targetCard.balance / (surplus * 0.9));
              const moderate = Math.ceil(targetCard.balance / (surplus * 0.5));
              r += `Options:\n`;
              r += `â€¢ Aggressive (90% of surplus): ~${fast} months at ${formatCurrency(surplus * 0.9)}/mo\n`;
              r += `â€¢ Moderate (50% of surplus): ~${moderate} months at ${formatCurrency(surplus * 0.5)}/mo\n`;
              r += `â€¢ Minimum payments only: ~${Math.ceil(targetCard.balance / targetCard.minimum)} months\n\n`;
              r += `Tell me which you prefer, like "set a goal to pay off ${q.includes('sapphire') ? 'Sapphire' : 'Amazon'} in ${fast} months"`;
            }
            return r;
          }
        }

        // Save X per month
        const saveMatch = q.match(/save\s*\$?([\d,]+)\s*(per|a|each|\/)\s*month/i) || q.match(/\$?([\d,]+)\s*(per|a|each|\/)\s*month.*sav/i);
        if (saveMatch || (q.includes('save') && amountMatch)) {
          const monthlyAmt = parseFloat((saveMatch ? saveMatch[1] : amountMatch[1]).replace(/,/g, ''));
          const forWhat = q.includes('emergency') ? 'emergency fund' : q.includes('reno') ? 'renovation' : 'savings';
          
          let r = `ğŸ“ Setting savings goal: ${formatCurrency(monthlyAmt)}/month for ${forWhat}\n\n`;
          r += `Your current surplus: ${formatCurrency(surplus)}\n`;
          
          if (monthlyAmt <= surplus) {
            r += `âœ… That fits within your surplus!\n\n`;
            const target = forWhat === 'emergency fund' ? data.emergencyFund.target : monthlyAmt * 12;
            addGoal({
              name: `Save ${formatCurrency(monthlyAmt)}/mo for ${forWhat}`,
              description: `Monthly contribution of ${formatCurrency(monthlyAmt)} toward ${forWhat}`,
              target: target,
              current: 0,
              monthlyAmount: monthlyAmt,
              months: Math.ceil(target / monthlyAmt),
              category: 'savings'
            });
            logDecision(`Savings goal set: ${formatCurrency(monthlyAmt)}/mo toward ${forWhat}`);
            r += `Goal saved! Check the Goals tab. ${getSheetsUrl() ? 'Synced to Google Sheets â˜ï¸' : ''}`;
          } else {
            r += `âš ï¸ That's more than your surplus. Max recommended: ${formatCurrency(surplus * 0.8)}/mo.\n`;
            r += `Want me to set it at ${formatCurrency(Math.floor(surplus * 0.8 / 50) * 50)}/mo instead?`;
          }
          return r;
        }

        // Monthly debt payoff goal
        const debtGoalMatch = q.match(/debt.*\$?([\d,]+)/i) || q.match(/\$?([\d,]+).*debt/i);
        if (q.includes('debt') && (debtGoalMatch || amountMatch)) {
          const monthlyAmt = parseFloat((debtGoalMatch ? debtGoalMatch[1] : amountMatch[1]).replace(/,/g, ''));
          let r = `ğŸ“ Monthly Debt Payoff Goal: ${formatCurrency(monthlyAmt)}/mo\n\n`;
          r += `Current CC minimums: ${formatCurrency(ccMinimums)}\n`;
          r += `Your surplus: ${formatCurrency(surplus)}\n`;
          const extraOverMin = monthlyAmt - ccMinimums;
          r += `Extra over minimums: ${formatCurrency(extraOverMin)}\n\n`;
          
          if (extraOverMin <= surplus) {
            const monthsToPayoff = Math.ceil(ccDebt / monthlyAmt);
            r += `At ${formatCurrency(monthlyAmt)}/mo total toward CC debt, you'd be free in ~${monthsToPayoff} months!\n\n`;
            addGoal({
              name: `Pay ${formatCurrency(monthlyAmt)}/mo toward credit card debt`,
              description: `${formatCurrency(ccMinimums)} minimums + ${formatCurrency(extraOverMin)} extra. Target: eliminate ${formatCurrency(ccDebt)} in ~${monthsToPayoff} months.`,
              target: ccDebt,
              current: 0,
              monthlyAmount: monthlyAmt,
              months: monthsToPayoff,
              category: 'debt-payoff'
            });
            logDecision(`Debt payoff goal: ${formatCurrency(monthlyAmt)}/mo toward CC debt. Est. payoff in ~${monthsToPayoff} months.`);
            r += `âœ… Goal saved! ${getSheetsUrl() ? 'Synced to Sheets â˜ï¸' : ''}`;
          } else {
            r += `âš ï¸ The extra ${formatCurrency(extraOverMin)} over minimums exceeds your ${formatCurrency(surplus)} surplus.\n`;
            r += `Realistic max: ${formatCurrency(ccMinimums + surplus)}/mo total.`;
          }
          return r;
        }

        // Budget / spending limit goal
        if (q.includes('cut') || q.includes('limit') || q.includes('budget') || q.includes('reduce') || q.includes('spend')) {
          const category = q.includes('dining') || q.includes('food') || q.includes('eating') ? 'dining/food' : 
                          q.includes('gas') || q.includes('fuel') ? 'gas/fuel' :
                          q.includes('shopping') ? 'shopping' :
                          q.includes('entertainment') ? 'entertainment' : 'spending';
          const limitAmt = amountMatch ? parseFloat(amountMatch[1].replace(/,/g, '')) : null;
          
          if (limitAmt) {
            addGoal({
              name: `Limit ${category} to ${formatCurrency(limitAmt)}/mo`,
              description: `Monthly budget cap for ${category}`,
              target: limitAmt,
              current: 0,
              monthlyAmount: limitAmt,
              category: 'budget-limit'
            });
            logDecision(`Budget limit set: ${category} capped at ${formatCurrency(limitAmt)}/mo`);
            return `âœ… Budget goal saved: Keep ${category} under ${formatCurrency(limitAmt)}/mo.\n\nThis is now tracked in your Goals tab. ${getSheetsUrl() ? 'Synced to Sheets â˜ï¸' : ''}\n\nğŸ’¡ Upload your latest credit card statement to see exactly where dining and delivery spending goes!`;
          }
          return `What monthly limit do you want for ${category}? For example: "Limit dining to $400/month"`;
        }

        // Generic goal
        if (amountMatch) {
          const amount = parseFloat(amountMatch[1].replace(/,/g, ''));
          addGoal({
            name: question,
            description: `Goal amount: ${formatCurrency(amount)}`,
            target: amount,
            current: 0,
            category: 'custom'
          });
          logDecision(question);
          return `âœ… Goal saved: "${question}"\n\nTarget: ${formatCurrency(amount)}\n\nYou can view and track this in the Goals tab. ${getSheetsUrl() ? 'Synced to Sheets â˜ï¸' : ''}`;
        }

        return `I can set goals for you! Try:\n\nâ€¢ "Set a goal to pay off the Sapphire in 12 months"\nâ€¢ "I want to save $500/month for emergencies"\nâ€¢ "Set a monthly debt payoff goal of $3,000"\nâ€¢ "Let's limit dining to $400/month"\nâ€¢ "Set a goal to save $10,000 by December"\n\nInclude a dollar amount and I'll build the plan!`;
      }

      // ===== CONFIRM / YES (follow-up to suggestions) =====
      if (q === 'yes' || q === 'yes save that' || q === 'save that' || q === 'do it' || q === 'sounds good' || q === 'ok' || q === 'yes please') {
        return `Got it! To confirm what to save, please repeat the goal with details. For example:\nâ€¢ "Set a goal to pay off Sapphire in 18 months"\nâ€¢ "Save $500/month for emergencies"\n\nI need the specifics to save it properly.`;
      }

      // ===== UPDATE GOAL PROGRESS =====
      if ((q.includes('update') || q.includes('progress') || q.includes('paid') || q.includes('saved')) && (q.includes('goal') || q.includes('toward'))) {
        const amtMatch = q.match(/\$?([\d,]+)/);
        if (amtMatch && data.goals && data.goals.length > 0) {
          const amount = parseFloat(amtMatch[1].replace(/,/g, ''));
          // Try to match to a goal
          let matchedGoal = null;
          if (q.includes('sapphire')) matchedGoal = data.goals.find(g => g.name.toLowerCase().includes('sapphire'));
          else if (q.includes('amazon')) matchedGoal = data.goals.find(g => g.name.toLowerCase().includes('amazon'));
          else if (q.includes('emergency') || q.includes('saving')) matchedGoal = data.goals.find(g => g.category === 'savings');
          else if (q.includes('debt')) matchedGoal = data.goals.find(g => g.category === 'debt-payoff');
          else matchedGoal = data.goals[0]; // default to first goal
          
          if (matchedGoal) {
            matchedGoal.current = (matchedGoal.current || 0) + amount;
            if (matchedGoal.current >= matchedGoal.target) matchedGoal.status = 'completed';
            else matchedGoal.status = 'on-track';
            saveData();
            autoSyncToSheets('goal-progress');
            updateAll();
            const pct = ((matchedGoal.current / matchedGoal.target) * 100).toFixed(0);
            logDecision(`Progress: ${formatCurrency(amount)} applied to "${matchedGoal.name}" â€” now at ${pct}%`);
            return `âœ… Updated "${matchedGoal.name}"!\n\nProgress: ${formatCurrency(matchedGoal.current)} / ${formatCurrency(matchedGoal.target)} (${pct}%)\n${matchedGoal.current >= matchedGoal.target ? '\nğŸ‰ GOAL COMPLETED!' : `\nRemaining: ${formatCurrency(matchedGoal.target - matchedGoal.current)}`}\n\n${getSheetsUrl() ? 'Synced to Sheets â˜ï¸' : ''}`;
          }
        }
        return `To update progress, include the amount and goal name. For example:\nâ€¢ "Paid $500 toward Sapphire goal"\nâ€¢ "Saved $200 toward emergency fund goal"`;
      }

      // ===== LOG A DECISION =====
      if (q.includes('decide') || q.includes('decision') || q.includes('agreed') || q.includes('we\'re going to') || q.includes('let\'s do') || q.includes('log') || q.includes('note')) {
        if (q.length > 15) { // meaningful content
          logDecision(question);
          updateAll();
          return `ğŸ“ Decision logged: "${question}"\n\nThis is saved in your Goals tab under Decisions Log${getSheetsUrl() ? ' and synced to Google Sheets â˜ï¸' : ''}.\n\nBoth of you can see it!`;
        }
        return `Tell me what you've decided and I'll log it. For example:\nâ€¢ "We decided to put the kitchen reno on hold until March"\nâ€¢ "Agreed to pay $3,000/mo toward credit cards"\nâ€¢ "Note: Expecting a raise in April"`;
      }

      // ===== SHOW GOALS =====
      if (q.includes('goal') && (q.includes('show') || q.includes('list') || q.includes('what') || q.includes('my') || q.includes('our'))) {
        if (!data.goals || data.goals.length === 0) {
          return `You don't have any goals set yet! I can help you create some. Try:\n\nâ€¢ "Set a goal to pay off Sapphire in 12 months"\nâ€¢ "I want to save $500/month"\nâ€¢ "Set a debt payoff goal of $3,000/month"`;
        }
        let r = `ğŸ“‹ Your Goals:\n\n`;
        data.goals.forEach((g, i) => {
          const pct = g.target > 0 ? ((g.current || 0) / g.target * 100).toFixed(0) : 0;
          r += `${i + 1}. ${g.name}\n`;
          r += `   ${g.target ? `${formatCurrency(g.current || 0)} / ${formatCurrency(g.target)} (${pct}%)` : ''}\n`;
          if (g.monthlyAmount) r += `   ${formatCurrency(g.monthlyAmount)}/mo\n`;
          r += `   Status: ${g.status || 'active'}\n\n`;
        });
        r += `Update progress by saying "Paid $X toward [goal name]"`;
        return r;
      }

      // ===== DOCUMENTS / UPLOADS / SPENDING BREAKDOWN =====
      if (q.includes('document') || q.includes('upload') || q.includes('file') && (q.includes('show') || q.includes('list') || q.includes('what'))) {
        if (!data.documents || data.documents.length === 0) {
          return `No documents uploaded yet. Tap the ğŸ“ button to upload:\n\nâ€¢ Credit card statements (PDF/text)\nâ€¢ Utility bills\nâ€¢ Pay stubs\nâ€¢ Mortgage statements\nâ€¢ Bank statements\nâ€¢ Any CSV/text with financial data\n\nI'll extract the numbers and add them to your budget automatically!`;
        }
        let r = `ğŸ“„ Uploaded Documents (${data.documents.length}):\n\n`;
        data.documents.forEach(doc => {
          r += `â€¢ ${doc.name}\n  Type: ${doc.type} | Uploaded: ${doc.uploadDate}\n  ${doc.summary}\n\n`;
        });
        r += `Upload more anytime with the ğŸ“ button!`;
        return r;
      }

      if (q.includes('spending') && (q.includes('breakdown') || q.includes('category') || q.includes('categories') || q.includes('where'))) {
        // Look for spending category data in documents
        let spendingData = null;
        if (data.documents) {
          for (const doc of data.documents) {
            if (doc.extractedData && doc.extractedData.spendingByCategory) {
              spendingData = { categories: doc.extractedData.spendingByCategory, source: doc.name };
              break;
            }
          }
        }
        if (spendingData) {
          let r = `ğŸ’³ Spending Breakdown (from ${spendingData.source}):\n\n`;
          const sorted = Object.entries(spendingData.categories).sort((a, b) => b[1] - a[1]);
          const total = sorted.reduce((a, [, v]) => a + v, 0);
          sorted.forEach(([cat, amt]) => {
            const pct = ((amt / total) * 100).toFixed(0);
            r += `â€¢ ${cat}: ${formatCurrency(amt)} (${pct}%)\n`;
          });
          r += `\nTotal: ${formatCurrency(total)}\n\n`;
          // Smart observations
          const dining = (spendingData.categories['Dining'] || 0) + (spendingData.categories['Delivery/DoorDash'] || 0);
          if (dining > 500) r += `ğŸ’¡ Dining + delivery is ${formatCurrency(dining)} â€” that's a big savings opportunity!`;
          return r;
        }
        return `I don't have spending category data yet. Upload a credit card statement (PDF or text) and I'll break down your spending by category!\n\nTap the ğŸ“ button to upload.`;
      }

      // ===== HELOC / CAN I AFFORD HELOC =====
      if ((q.includes('afford') || q.includes('handle') || q.includes('manage') || q.includes('take on') || q.includes('swing')) && (q.includes('heloc') || q.includes('renovation') || q.includes('loan') || q.includes('renofi'))) {
        let r = `ğŸ“Š HELOC Affordability Analysis:\n\n`;
        r += `Current monthly surplus: ${formatCurrency(surplus)}\n`;
        r += `HELOC payment (full $300k draw): ${formatCurrency(helocPayment)}/mo\n\n`;
        
        if (surplus >= helocPayment) {
          r += `âœ… YES â€” your surplus of ${formatCurrency(surplus)} covers the ${formatCurrency(helocPayment)} HELOC payment with ${formatCurrency(surplus - helocPayment)} to spare.\n\n`;
        } else if (surplus > 0) {
          const shortfall = helocPayment - surplus;
          r += `âš ï¸ TIGHT â€” your surplus is ${formatCurrency(surplus)}, but the HELOC payment is ${formatCurrency(helocPayment)}. That's a shortfall of ${formatCurrency(shortfall)}/mo.\n\n`;
          r += `To make it work you'd need to:\n`;
          r += `â€¢ Cut expenses by ${formatCurrency(shortfall)}/mo, OR\n`;
          r += `â€¢ Increase income by ${formatCurrency(shortfall)}/mo, OR\n`;
          r += `â€¢ Draw less than the full $300k\n\n`;
          // Estimate max affordable draw
          const maxDraw = (surplus / helocPayment) * data.heloc.total;
          r += `At your current surplus, you could comfortably handle ~${formatCurrency(maxDraw)} drawn.\n\n`;
        } else {
          r += `âŒ NOT YET â€” you're already running a deficit of ${formatCurrency(Math.abs(surplus))}/mo before the HELOC.\n\n`;
          r += `You'd need to free up ${formatCurrency(helocPayment + Math.abs(surplus))}/mo to cover the HELOC payment.\n\n`;
        }
        
        r += `But keep in mind:\n`;
        r += `â€¢ During the ${helocDrawPeriod}-year draw period, you only pay interest on what's drawn (not the full $300k right away)\n`;
        r += `â€¢ At ${helocRate}% on $50k drawn, that's only ~${formatCurrency(50000 * helocRate / 100 / 12)}/mo\n`;
        r += `â€¢ The full ${formatCurrency(helocPayment)} kicks in during the ${helocRepayment}-year repayment phase\n`;
        
        if (ccDebt > 0) {
          r += `\nğŸ’¡ Big opportunity: You're paying ~${formatCurrency(totalCCInterest)}/mo in CC interest at ${sapphire ? sapphire.apr : '~24'}% APR. If you paid off the CC debt first, that frees up ${formatCurrency(ccMinimums)}/mo in minimum payments.`;
        }
        return r;
      }

      // ===== AFFORD GENERIC (with dollar amount) =====
      if (q.includes('afford') || q.includes('can we') || q.includes('can i')) {
        const amountMatch = q.match(/\$?([\d,]+)/);
        if (amountMatch) {
          const amount = parseFloat(amountMatch[1].replace(/,/g, ''));
          if (amount <= surplus) {
            return `âœ… Yes â€” ${formatCurrency(amount)} fits within your monthly surplus of ${formatCurrency(surplus)}, leaving ${formatCurrency(surplus - amount)} remaining.\n\nFor context, your monthly obligations are ${formatCurrency(totalObligations)} against ${formatCurrency(income)} income.`;
          } else if (surplus > 0 && amount <= surplus * 6) {
            const months = Math.ceil(amount / surplus);
            return `âš ï¸ Not in one month (surplus is ${formatCurrency(surplus)}), but you could save for it in ~${months} months.\n\nAlternatively, ${amount <= helocRemaining ? `you could draw from HELOC (${formatCurrency(helocRemaining)} available) if it's renovation-related.` : 'consider financing options.'}`;
          } else {
            return `âŒ ${formatCurrency(amount)} is a stretch. Your surplus is ${formatCurrency(surplus)}/mo â€” that's ${surplus > 0 ? Math.ceil(amount / surplus) + ' months' : 'not possible right now since you\'re in deficit'}.\n\nHELOC has ${formatCurrency(helocRemaining)} available for renovation expenses.`;
          }
        }
        // No dollar amount â€” give general affordability picture
        return `Here's your affordability snapshot:\n\nâ€¢ Monthly income: ${formatCurrency(income)}\nâ€¢ Monthly obligations: ${formatCurrency(totalObligations)}\nâ€¢ Monthly surplus: ${formatCurrency(surplus)}\nâ€¢ CC minimums eating: ${formatCurrency(ccMinimums)}/mo\nâ€¢ CC interest burning: ~${formatCurrency(totalCCInterest)}/mo\n\nTip: Ask me "Can I afford $X?" with a specific amount, or "Can I afford the HELOC?" for a detailed analysis.`;
      }

      // ===== INCOME =====
      if (q.includes('income') || q.includes('make') || q.includes('earn') || q.includes('salary') || q.includes('paycheck')) {
        return `Combined monthly income: ${formatCurrency(income)}\n\nâ€¢ ${p1()}${p1Emp()}: ${formatCurrency(data.income.person1)}\nâ€¢ ${p2()}${p2Emp()}: ${formatCurrency(data.income.person2)}\nâ€¢ ${data.incomeLabels?.other1 || 'Benefits'}: ${formatCurrency(data.income.other1)}${data.income.other2 > 0 ? `\nâ€¢ Other: ${formatCurrency(data.income.other2)}` : ''}\n\nAfter all obligations (${formatCurrency(totalObligations)}), your surplus is ${formatCurrency(surplus)}/mo.`;
      }

      // ===== SURPLUS =====
      if (q.includes('surplus') || q.includes('left over') || q.includes('leftover') || q.includes('extra') || q.includes('spare') || q.includes('breathing room')) {
        if (surplus >= 0) {
          let r = `Monthly surplus: ${formatCurrency(surplus)}\n\n`;
          r += `Income: ${formatCurrency(income)}\nObligations: ${formatCurrency(totalObligations)}\n\n`;
          r += `Breakdown of obligations:\n`;
          r += `â€¢ Fixed bills: ${formatCurrency(fixedExpenses)}\n`;
          r += `â€¢ CC minimums: ${formatCurrency(ccMinimums)}\n`;
          if (helocInterest > 0) r += `â€¢ HELOC interest: ${formatCurrency(helocInterest)}\n`;
          r += `\nBest use of surplus:\n`;
          if (ccDebt > 0) r += `1. Attack CC debt (saving ~${formatCurrency(totalCCInterest)}/mo in interest)\n`;
          if (data.emergencyFund.current < data.emergencyFund.target) r += `${ccDebt > 0 ? '2' : '1'}. Build emergency fund (${formatCurrency(data.emergencyFund.current)} of ${formatCurrency(data.emergencyFund.target)} goal)\n`;
          return r;
        } else {
          return `âš ï¸ You're running a deficit of ${formatCurrency(Math.abs(surplus))}/mo.\n\nIncome: ${formatCurrency(income)}\nObligations: ${formatCurrency(totalObligations)}\n\nBiggest costs:\nâ€¢ CC minimums: ${formatCurrency(ccMinimums)}/mo\nâ€¢ Mortgage: ${formatCurrency(data.mortgage.payment)}/mo\nâ€¢ Fixed bills: ${formatCurrency(fixedExpenses - data.mortgage.payment)}/mo\n\nConsider reducing discretionary spending or increasing income.`;
        }
      }

      // ===== INTEREST / WASTING =====
      if (q.includes('interest') || q.includes('wasting') || q.includes('costing') || q.includes('burning')) {
        let r = `ğŸ’¸ Monthly Interest Costs:\n\n`;
        data.creditCards.forEach(c => {
          const monthlyInt = c.lastInterest || (c.balance * c.apr / 100 / 12);
          r += `â€¢ ${c.name}: ~${formatCurrency(monthlyInt)}/mo (${c.apr}% on ${formatCurrency(c.balance)})\n`;
        });
        r += `\nTotal CC interest: ~${formatCurrency(totalCCInterest)}/mo (${formatCurrency(totalCCInterest * 12)}/yr)\n`;
        if (helocInterest > 0) r += `HELOC interest: ${formatCurrency(helocInterest)}/mo\n`;
        r += `\nThat's ${formatCurrency(totalCCInterest + helocInterest)} going to interest every month instead of your renovation or savings.`;
        if (sapphire && sapphire.balance > sapphire.limit) {
          r += `\n\nâš ï¸ Your Sapphire Reserve is over its credit limit by ${formatCurrency(sapphire.balance - sapphire.limit)}!`;
        }
        return r;
      }

      // ===== CREDIT CARDS =====
      if (q.includes('credit card') || q.includes('cards') || q.includes('sapphire') || q.includes('amazon') || q.includes('chase')) {
        if (q.includes('sapphire') && sapphire) {
          const util = ((sapphire.balance / sapphire.limit) * 100).toFixed(0);
          let r = `Chase Sapphire Reserve:\n\n`;
          r += `â€¢ Balance: ${formatCurrency(sapphire.balance)}\n`;
          r += `â€¢ Credit Limit: ${formatCurrency(sapphire.limit)}\n`;
          r += `â€¢ Utilization: ${util}%${sapphire.balance > sapphire.limit ? ' âš ï¸ OVER LIMIT by ' + formatCurrency(sapphire.balance - sapphire.limit) : ''}\n`;
          r += `â€¢ APR: ${sapphire.apr}%\n`;
          r += `â€¢ Monthly Interest: ~${formatCurrency(sapphire.lastInterest || (sapphire.balance * sapphire.apr / 100 / 12))}\n`;
          r += `â€¢ Minimum Due: ${formatCurrency(sapphire.minimum)}\n`;
          r += `â€¢ Due Date: ${sapphire.dueDate || 'N/A'}\n`;
          r += `â€¢ AutoPay: ${sapphire.autopay ? 'âœ… ON' : 'âŒ OFF'}\n`;
          r += `â€¢ Rewards: ${sapphire.rewards || 'N/A'}\n`;
          r += `â€¢ Pay Over Time plans: $2,823.73 remaining (6 active plans)`;
          return r;
        }
        if (q.includes('amazon') && amazon) {
          const util = ((amazon.balance / amazon.limit) * 100).toFixed(0);
          let r = `Chase Amazon Prime Visa:\n\n`;
          r += `â€¢ Balance: ${formatCurrency(amazon.balance)}\n`;
          r += `â€¢ Credit Limit: ${formatCurrency(amazon.limit)}\n`;
          r += `â€¢ Utilization: ${util}%\n`;
          r += `â€¢ APR: ${amazon.apr}%\n`;
          r += `â€¢ Monthly Interest: ~${formatCurrency(amazon.lastInterest || (amazon.balance * amazon.apr / 100 / 12))}\n`;
          r += `â€¢ Minimum Due: ${formatCurrency(amazon.minimum)}\n`;
          r += `â€¢ Due Date: ${amazon.dueDate || 'N/A'}\n`;
          r += `â€¢ AutoPay: ${amazon.autopay ? 'âœ… ON' : 'âŒ OFF â€” consider turning this on!'}\n`;
          r += `â€¢ Rewards: ${amazon.rewards || 'N/A'}`;
          return r;
        }
        let r = `ğŸ’³ Credit Cards â€” Total: ${formatCurrency(ccDebt)}\n\n`;
        data.creditCards.sort((a, b) => b.apr - a.apr).forEach(card => {
          const monthlyInt = card.lastInterest || (card.balance * card.apr / 100 / 12);
          r += `${card.name}:\n`;
          r += `  ${formatCurrency(card.balance)} at ${card.apr}% â†’ ~${formatCurrency(monthlyInt)}/mo interest\n`;
          r += `  Min: ${formatCurrency(card.minimum)} â€¢ Due: ${card.dueDate || 'N/A'}${card.autopay ? ' â€¢ AutoPay âœ…' : ' â€¢ AutoPay âŒ'}\n\n`;
        });
        r += `Combined interest: ~${formatCurrency(totalCCInterest)}/mo\nCombined minimums: ${formatCurrency(ccMinimums)}/mo\n\n`;
        r += `ğŸ’¡ Avalanche strategy: Pay minimums on Amazon (${amazon ? amazon.apr : '22.74'}%), throw extra at Sapphire (${sapphire ? sapphire.apr : '24.99'}%) first â€” it has the higher rate.`;
        return r;
      }

      // ===== DEBT OVERVIEW =====
      if (q.includes('debt') || q.includes('owe')) {
        let r = `Total debt: ${formatCurrency(totalDebt)}\n\n`;
        if (ccDebt > 0) {
          r += `ğŸ’³ Credit Cards: ${formatCurrency(ccDebt)}\n`;
          data.creditCards.forEach(c => {
            r += `   â€¢ ${c.name}: ${formatCurrency(c.balance)} (${c.apr}%)\n`;
          });
        }
        if (slDebt > 0) r += `ğŸ“ Student Loans: ${formatCurrency(slDebt)}\n`;
        if (data.heloc.drawn > 0) r += `ğŸ  HELOC: ${formatCurrency(data.heloc.drawn)}\n`;
        r += `\nMonthly debt payments: ${formatCurrency(ccMinimums + data.studentLoans.reduce((a, l) => a + l.payment, 0) + helocInterest)}\n`;
        r += `Monthly interest burned: ~${formatCurrency(totalCCInterest + helocInterest)}\n\n`;
        
        if (surplus > 0 && ccDebt > 0) {
          // Simple payoff estimate (ignoring interest for rough calc)
          const monthsToPayCC = Math.ceil(ccDebt / (surplus + ccMinimums * 0.3));
          r += `If you put your full surplus toward CC debt, you could be free in roughly ${monthsToPayCC}-${Math.ceil(monthsToPayCC * 1.3)} months.`;
        }
        return r;
      }

      // ===== PAYOFF / STRATEGY =====
      if (q.includes('pay off') || q.includes('payoff') || q.includes('strategy') || q.includes('plan') || q.includes('avalanche') || q.includes('snowball') || q.includes('get out of debt')) {
        let r = `ğŸ¯ Debt Payoff Strategy:\n\n`;
        r += `Recommended: Avalanche Method (highest interest first)\n\n`;
        
        const allDebts = [
          ...data.creditCards.map(c => ({ name: c.name, balance: c.balance, rate: c.apr, minimum: c.minimum, type: 'CC' })),
          ...data.studentLoans.filter(l => l.balance > 0).map(l => ({ name: l.name, balance: l.balance, rate: l.rate, minimum: l.payment, type: 'SL' }))
        ].sort((a, b) => b.rate - a.rate);
        
        r += `Priority order:\n`;
        allDebts.forEach((d, i) => {
          r += `${i + 1}. ${d.name} â€” ${formatCurrency(d.balance)} at ${d.rate}%\n`;
        });
        
        r += `\nYour surplus: ${formatCurrency(surplus)}/mo\n\n`;
        if (surplus > 0) {
          r += `Action plan:\n`;
          r += `â€¢ Pay minimums on everything (${formatCurrency(ccMinimums + data.studentLoans.reduce((a, l) => a + l.payment, 0))})\n`;
          r += `â€¢ Throw extra ${formatCurrency(surplus)} at ${allDebts[0]?.name || 'highest rate debt'}\n`;
          r += `â€¢ Once that's paid off, roll its payment into the next one\n\n`;
          r += `Each CC you pay off frees up its minimum payment AND stops ${formatCurrency(totalCCInterest)}/mo in interest from growing.`;
        } else {
          r += `âš ï¸ Your surplus is negative â€” focus on cutting expenses before aggressive payoff.`;
        }
        return r;
      }

      // ===== HELOC DETAILS =====
      if (q.includes('heloc') || q.includes('renofi') || q.includes('draw')) {
        let r = `ğŸ  HELOC Details (${helocLender}):\n\n`;
        r += `â€¢ Loan Amount: ${formatCurrency(data.heloc.total)}\n`;
        r += `â€¢ Fixed Rate: ${helocRate}%\n`;
        r += `â€¢ Draw Period: ${helocDrawPeriod} years\n`;
        r += `â€¢ Repayment Period: ${helocRepayment} years\n`;
        r += `â€¢ Est. Monthly Payment (full draw): ${formatCurrency(helocPayment)}\n`;
        r += `â€¢ Status: ${data.heloc.status || 'Pursuing'}\n\n`;
        r += `â€¢ Amount Drawn: ${formatCurrency(data.heloc.drawn)}\n`;
        r += `â€¢ Remaining to Draw: ${formatCurrency(helocRemaining)}\n`;
        r += `â€¢ Current Monthly Interest: ${formatCurrency(helocInterest)}\n\n`;
        
        if (data.heloc.drawn > 0) {
          const drawRatio = data.heloc.drawn / data.heloc.total;
          r += `At current draw, estimated payment: ~${formatCurrency(helocPayment * drawRatio)}/mo\n`;
        } else {
          r += `No funds drawn yet. During the draw period, you'll only pay interest on what you've used.\n`;
          r += `Example: Draw $50k â†’ ~${formatCurrency(50000 * helocRate / 100 / 12)}/mo in interest.`;
        }
        return r;
      }

      // ===== RENOVATION =====
      if (q.includes('renovation') || q.includes('remodel') || q.includes('project')) {
        let r = `ğŸ”¨ Renovation Budget:\n\n`;
        r += `Total Budget: ${formatCurrency(data.renovation.budget)}\n`;
        r += `Spent: ${formatCurrency(renoSpent)}\n`;
        r += `Remaining: ${formatCurrency(renoRemaining)}\n\n`;
        r += `By category:\n`;
        for (const [name, cat] of Object.entries(data.renovation.categories)) {
          const pct = cat.budget > 0 ? ((cat.spent / cat.budget) * 100).toFixed(0) : 0;
          r += `â€¢ ${name}: ${formatCurrency(cat.spent)} / ${formatCurrency(cat.budget)} (${pct}%)\n`;
        }
        r += `\nFunded by: ${helocLender} HELOC at ${helocRate}% fixed\n`;
        r += `HELOC drawn so far: ${formatCurrency(data.heloc.drawn)} of ${formatCurrency(data.heloc.total)}`;
        return r;
      }

      // ===== RENOVATION CATEGORIES =====
      const categories = ['kitchen', 'bathroom', 'flooring', 'hvac', 'electrical', 'plumbing', 'exterior', 'windows', 'doors'];
      for (const cat of categories) {
        if (q.includes(cat)) {
          const catName = Object.keys(data.renovation.categories).find(k => k.toLowerCase().includes(cat));
          if (catName) {
            const c = data.renovation.categories[catName];
            const pct = c.budget > 0 ? ((c.spent / c.budget) * 100).toFixed(1) : 0;
            return `${catName} Budget:\n\nâ€¢ Budget: ${formatCurrency(c.budget)}\nâ€¢ Spent: ${formatCurrency(c.spent)}\nâ€¢ Remaining: ${formatCurrency(c.budget - c.spent)}\nâ€¢ Progress: ${pct}%`;
          }
        }
      }

      // ===== EMERGENCY FUND =====
      if (q.includes('emergency') || q.includes('savings') || q.includes('fund') || q.includes('rainy day')) {
        let r = `ğŸ¦ Emergency Fund:\n\nâ€¢ Current: ${formatCurrency(data.emergencyFund.current)}\nâ€¢ Goal: ${formatCurrency(data.emergencyFund.target)}\nâ€¢ Progress: ${emergencyProgress.toFixed(1)}%\n`;
        if (data.emergencyFund.current >= data.emergencyFund.target) {
          r += `\nğŸ‰ Goal reached!`;
        } else if (surplus > 0) {
          r += `\nAt ${formatCurrency(surplus)}/mo surplus, you'd reach the goal in ~${monthsToEmergency} months.\n\n`;
          r += `ğŸ’¡ Most advisors recommend building at least $1,000-$2,000 in emergency savings before aggressively paying debt, then splitting surplus between debt payoff and emergency fund.`;
        } else {
          r += `\nâš ï¸ With a negative surplus, focus on reducing expenses before building this fund.`;
        }
        return r;
      }

      // ===== EXPENSES / BILLS =====
      if (q.includes('expense') || q.includes('bills') || q.includes('pay') || q.includes('spending') || q.includes('obligations')) {
        let r = `Monthly Obligations: ${formatCurrency(totalObligations)}\n\n`;
        r += `Fixed Bills:\n`;
        for (const [name, amount] of Object.entries(data.expenses)) {
          r += `â€¢ ${name}: ${formatCurrency(amount)}\n`;
        }
        r += `\nDebt Payments:\n`;
        r += `â€¢ CC Minimums: ${formatCurrency(ccMinimums)}\n`;
        if (helocInterest > 0) r += `â€¢ HELOC Interest: ${formatCurrency(helocInterest)}\n`;
        r += `\nTotal: ${formatCurrency(totalObligations)} of ${formatCurrency(income)} income (${((totalObligations / income) * 100).toFixed(0)}%)`;
        return r;
      }

      // ===== MORTGAGE =====
      if (q.includes('mortgage') || q.includes('house payment')) {
        let r = `ğŸ¡ Mortgage${data.profile?.mortgageLender ? ' (' + data.profile.mortgageLender + ')' : ''}:\n\n`;
        r += `â€¢ Monthly Payment: ${formatCurrency(data.mortgage.payment)}\n`;
        r += `â€¢ Outstanding Balance: ${data.mortgage.balance > 0 ? formatCurrency(data.mortgage.balance) : 'Not entered'}\n`;
        r += `â€¢ Interest Rate: ${data.mortgage.rate > 0 ? data.mortgage.rate + '%' : 'Not entered'}\n`;
        if (data.mortgage.nextDueDate) r += `â€¢ Next Due: ${data.mortgage.nextDueDate}\n`;
        if (data.mortgage.autopay) r += `â€¢ AutoPay: âœ… Enabled\n`;
        if (data.mortgage.principalPaid) r += `\nğŸ“Š Payment Breakdown:\nâ€¢ Principal: ${formatCurrency(data.mortgage.principalPaid)}\nâ€¢ Interest: ${formatCurrency(data.mortgage.interestPaid)}\nâ€¢ Escrow (tax/insurance): ${formatCurrency(data.mortgage.escrowPaid)}\n`;
        if (data.mortgage.escrowBalance) r += `\nâ€¢ Escrow Balance: ${formatCurrency(data.mortgage.escrowBalance)}`;
        if (data.mortgage.ytdTotal) r += `\n\nğŸ“… Year-to-Date:\nâ€¢ Principal paid: ${formatCurrency(data.mortgage.ytdPrincipal)}\nâ€¢ Interest paid: ${formatCurrency(data.mortgage.ytdInterest)}\nâ€¢ Total paid: ${formatCurrency(data.mortgage.ytdTotal)}`;
        if (data.mortgage.loanNumber) r += `\n\nLoan #: ${data.mortgage.loanNumber}`;
        if (data.mortgage.prepaymentPenalty === false) r += ` | No prepayment penalty`;
        r += `\n\nThis is ${((data.mortgage.payment / income) * 100).toFixed(0)}% of your monthly income.`;
        return r;
      }

      // ===== STUDENT LOANS =====
      if (q.includes('student')) {
        let r = `ğŸ“ Student Loans:\n`;
        data.studentLoans.forEach(loan => {
          r += `\nâ€¢ ${loan.name}: ${loan.balance > 0 ? formatCurrency(loan.balance) : 'Balance TBD'} â€” ${formatCurrency(loan.payment)}/mo`;
        });
        r += `\n\nTotal Monthly: ${formatCurrency(data.studentLoans.reduce((a, l) => a + l.payment, 0))}`;
        return r;
      }

      // ===== SUMMARY / STATUS =====
      if (q.includes('summary') || q.includes('overview') || q.includes('status') || q.includes('how are we') || q.includes('snapshot') || q.includes('big picture')) {
        let r = `ğŸ“Š Financial Snapshot:\n\n`;
        r += `ğŸ’µ Income: ${formatCurrency(income)}/mo\n`;
        r += `ğŸ’¸ Obligations: ${formatCurrency(totalObligations)}/mo\n`;
        r += `${surplus >= 0 ? 'âœ…' : 'âš ï¸'} Surplus: ${formatCurrency(surplus)}/mo\n\n`;
        r += `ğŸ’³ Credit Card Debt: ${formatCurrency(ccDebt)}\n`;
        r += `   Interest cost: ~${formatCurrency(totalCCInterest)}/mo\n`;
        r += `ğŸ  HELOC: ${formatCurrency(data.heloc.drawn)} drawn of ${formatCurrency(data.heloc.total)} (${helocLender}, ${helocRate}% fixed)\n`;
        r += `   Full draw payment: ${formatCurrency(helocPayment)}/mo\n`;
        r += `ğŸ”¨ Renovation: ${formatCurrency(renoSpent)} of ${formatCurrency(data.renovation.budget)} spent\n`;
        r += `ğŸ¦ Emergency Fund: ${formatCurrency(data.emergencyFund.current)} of ${formatCurrency(data.emergencyFund.target)} (${emergencyProgress.toFixed(0)}%)\n\n`;
        
        // Smart advice
        if (ccDebt > 20000) {
          r += `ğŸš¨ Priority: Your CC debt is costing ~${formatCurrency(totalCCInterest * 12)}/year in interest. Consider attacking this before starting the renovation draw.`;
        } else if (surplus < helocPayment) {
          r += `âš ï¸ Watch: Your surplus won't cover the full HELOC payment yet. Focus on freeing up cash flow.`;
        } else {
          r += `ğŸ’ª You're in a position to move forward with the renovation!`;
        }
        return r;
      }

      // ===== DUE DATES =====
      if (q.includes('due') || q.includes('when') || q.includes('payment date')) {
        let r = `ğŸ“… Upcoming Due Dates:\n\n`;
        data.creditCards.forEach(c => {
          r += `â€¢ ${c.name}: ${c.dueDate || 'N/A'} â€” ${formatCurrency(c.minimum)} min${c.autopay ? ' (AutoPay âœ…)' : ' âš ï¸ NO AUTOPAY'}\n`;
        });
        r += `â€¢ Mortgage: Monthly â€” ${formatCurrency(data.mortgage.payment)}\n`;
        data.studentLoans.forEach(l => {
          r += `â€¢ ${l.name}: Monthly â€” ${formatCurrency(l.payment)}\n`;
        });
        return r;
      }

      // ===== REWARDS =====
      if (q.includes('reward') || q.includes('points')) {
        let r = `ğŸ Credit Card Rewards:\n\n`;
        data.creditCards.forEach(c => {
          r += `â€¢ ${c.name}: ${c.rewards || 'None tracked'}\n`;
        });
        r += `\nğŸ’¡ Consider redeeming points toward statement credit to help pay down balances.`;
        return r;
      }

      // ===== ADVICE / RECOMMENDATION / WHAT SHOULD =====
      if (q.includes('advice') || q.includes('recommend') || q.includes('should') || q.includes('priority') || q.includes('what next') || q.includes('focus')) {
        let r = `ğŸ’¡ Recommended Priority Order:\n\n`;
        let step = 1;
        
        if (data.emergencyFund.current < 2000) {
          r += `${step}. Build emergency fund to $2,000 (currently ${formatCurrency(data.emergencyFund.current)})\n`;
          step++;
        }
        if (ccDebt > 0) {
          r += `${step}. Attack credit card debt (${formatCurrency(ccDebt)} at ~${sapphire ? sapphire.apr : '24'}% APR)\n`;
          r += `   â†’ You're losing ~${formatCurrency(totalCCInterest)}/mo to interest\n`;
          r += `   â†’ Sapphire is over its credit limit â€” fix this first\n`;
          step++;
        }
        if (data.emergencyFund.current < data.emergencyFund.target) {
          r += `${step}. Build emergency fund to ${formatCurrency(data.emergencyFund.target)}\n`;
          step++;
        }
        r += `${step}. Start HELOC draws for renovation\n`;
        r += `   â†’ ${formatCurrency(helocPayment)}/mo at full draw (${helocRate}% is much better than ${sapphire ? sapphire.apr : '24.99'}% CC rate)\n`;
        step++;
        r += `\nâš¡ Quick win: The Sapphire is at ${sapphire ? ((sapphire.balance / sapphire.limit) * 100).toFixed(0) : '100'}% utilization. Getting it under 90% would help your credit score for the HELOC application.`;
        return r;
      }

      // ===== HELP =====
      if (q.includes('help') || q.includes('what can')) {
        return `I know your finances and can help you plan! Ask me:\n\nğŸ“Š Analysis:\nâ€¢ "Can I afford the HELOC?"\nâ€¢ "How much interest are we wasting?"\nâ€¢ "What should we focus on?"\nâ€¢ "Where is our money going?" (spending breakdown)\n\nğŸ“ Set Goals (I'll save these!):\nâ€¢ "Set a goal to pay off Sapphire in 12 months"\nâ€¢ "Save $500/month for emergencies"\nâ€¢ "Limit dining to $400/month"\n\nğŸ“ Upload Documents:\nâ€¢ Tap the ğŸ“ button to upload statements, bills, pay stubs\nâ€¢ I'll extract data and update your budget automatically\nâ€¢ "Show my documents" to see what's uploaded\n\nâœ… Track & Log:\nâ€¢ "Paid $500 toward Sapphire goal"\nâ€¢ "We decided to start the kitchen in April"\n\nEverything syncs to Google Sheets when connected!`;
      }

      // ===== FALLBACK =====
      return `I'm not sure about that, but I know your finances inside and out! Try asking:\n\nâ€¢ "Can I afford the HELOC?"\nâ€¢ "What's our surplus?"\nâ€¢ "How much interest are we wasting?"\nâ€¢ "What should we focus on?"\nâ€¢ "How are we doing?"\n\nOr ask "help" to see everything I can answer.`;
    }
  </script>

</body>
</html>
